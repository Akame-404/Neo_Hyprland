(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[31282],{415191:(e,t,n)=>{"use strict";n.d(t,{KW:()=>o.KW,wW:()=>i.getCurrentClientSessionId});var o=n(331282),i=n(469053)},331282:(e,t,n)=>{"use strict";n.d(t,{m7:()=>P,pv:()=>B,_r:()=>I,Oz:()=>R,PH:()=>x,JD:()=>T,y0:()=>ge,a_:()=>ie,KW:()=>ce});n(21703);var o=n(59391),i=n(742741),s=n(568626),r=n(471924),a=n(990038),c=n(653965),d=n(552629),l=n(476870),u=n(937850),g=n(701525),h=n(619584),m=n(63811),v=n(95477),p=n(920939),f=n(79016),S=n(604569),b=n(80444);n(788632);const k=!1;var w=n(701302),y=n(730459),_=n(319385);function C(e,t){w.default.afterNextFlush((()=>{_.default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&y.K4(e,"audio_processor.client.send_request",t)}))}var D=n(469053);const R="transcription",x="vad",I="rate_limited",P="forbidden",B="openai_error",T=(0,o.Z)(),M=async()=>Promise.all([n.e(69053),n.e(87168)]).then(n.bind(n,469053)),A=!1,E=90*h.C0;function Z(e){return{_id:e,charactersSent:0,requestsSent:0,requestsTimedOut:0,responsesReceivedWithoutHandlers:0,successfulResponsesReceived:0,unsuccessfulResponsesReceived:0,invalidMessagesReceived:0,notificationsReceived:0,messagesReceived:0}}const q=new a.z(20),N=new Map,j=(Date.now(),"audioProcessorInternals"),L=new s.BatchedLogger({from:j,type:"BulkDebug",level:"info",maxLength:250,logToConsole:A});let F,O=0,W=0,U=0,G=0,K=Z(0),$=null,J=null,z=null,H=0,V=g.O,Q=!1,Y="uninitialized";const X=!0;function ee(e){L.log({level:"info",from:j,type:e})}function te(){F=function(e){var t;const n=null==e||null===(t=e.socket)||void 0===t||null===(t=t.transport)||void 0===t||null===(t=t.query)||void 0===t?void 0:t.transport;if("websocket"===n||"polling"===n)return n}(this),ee(`ping:${F}`),$=Date.now(),me(`Incoming primus ping received from server via ${F}.`)}function ne(){return{...q.getStats()}}function oe(e){switch(L.log({level:"info",from:j,type:"readyStateChange",data:{message:e}}),z=Date.now(),e){case"end":Y="closed";break;case"open":Y="open";break;case"opening":Y="opening"}}const ie=c.HP((e=>async function(e){if(k)return;O+=1;const{createClient:t}=await M(),n=t({minReconnectDelayMs:.5*h.C0,maxReconnectDelayMs:2*h.C0});return n.on("data",le),n.on("open",(()=>{S.Z.setState("connected"),ee("open"),K=Z(K._id+1),A&&function(){const e=Date.now(),t=20;function n(){const o=ne();if(0===o.queue&&0===o.running)return me(`Queues emptied after ${Date.now()-e} ms`),void(se=void 0);se=window.setTimeout(n,t)}se&&window.clearTimeout(se),me("Starting measurement of time until send queues are empty."),n()}()})),n.on("reconnected",(e=>{var t;(t=null==e?void 0:e.duration)&&t>1e4?ae():Q=!1,L.log({level:"info",from:j,type:"reconnected",data:{message:`Reconnected in ${null==e?void 0:e.duration} ms`}})})),n.on("reconnect",(()=>{ee("reconnect")})),n.on("reconnect scheduled",(e=>{(void 0===(null==e?void 0:e.attempt)||void 0===(null==e?void 0:e.duration)||e.attempt>2||e.duration>5e3||void 0===S.Z.state)&&S.Z.setState("disconnected"),L.log({level:"info",from:j,type:"reconnect scheduled",data:{message:`Reconnecting in ${null==e?void 0:e.scheduled} ms, attempt ${null==e?void 0:e.attempt} of ${null==e?void 0:e.retries}`}})})),n.on("reconnect timeout",(()=>{ee("reconnect timeout")})),n.on("reconnect failed",(()=>{ee("reconnect failed")})),n.on("timeout",(()=>{ee("timeout")})),n.on("destroy",(()=>{ee("destroy")})),n.on("close",(()=>{ee("close")})),n.on("online",(()=>{ee("online")})),n.on("offline",(()=>{ee("offline")})),n.on("error",(e=>{let t;t="TransportError"===e.type?{level:"info",from:j,type:"primusTransportError",error:(0,d.Ui)(e)}:{level:"error",from:j,type:"unknownPrimusError",error:(0,d.Ui)(e)};(0,l.lB)(1)&&s.rateLimitedLog(t),L.log(t),U+=1})),n.on("incoming::ping",te),n.on("readyStateChange",oe),n.on("end",(()=>{ee("end"),n.off("readyStateChange",oe),W+=1,ue(n,e)})),window.__primusClient_audioProcessor=n,n}(e)),(function(){return"primus_audioProcessor"}));let se,re;function ae(){var e;Q=!1,q.cancel(),function(){for(const e of N.values())window.clearTimeout(e.timeout);N.clear()}(),null===(e=re)||void 0===e||e()}async function ce(e){var t,n;const{base64Audio:o,environment:i,language:s}=e,r=null===(t=b.default.state.currentUserStore)||void 0===t?void 0:t.id,a=null===(n=b.default.state.currentSpaceStore)||void 0===n?void 0:n.id;var c;if(r&&a)return await(null===(c=de({method:"audioData",request:{base64Audio:o,language:s,userId:r,spaceId:a},environment:i}))||void 0===c?void 0:c.response);{const e=r||a?r?"Space":"User":"Both";return await(0,p.stopDictation)({environment:i,error:new f.c2(e)})}}function de(e){if(k)return;const{method:t,request:n,environment:o}=e;C(o,{status:"enqueued",endpoint:t});const i=q.enqueue((()=>{var i;const s=r.Il();!function(e,t){w.default.afterNextFlush((()=>{_.default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&(y.K4(e,"audio_processor.client.send_request.queue_running_size",{value:t.running}),y.K4(e,"audio_processor.client.send_request.queue_backup_size",{value:t.queue}))}))}(o,q.getStats());const a=u.UZ(),c=Date.now(),d=X?window.setTimeout((()=>{"open"===Y&&(K.requestsTimedOut+=1,L.log({level:"info",from:j,type:"requestTimeout",data:{requestId:s,time:Date.now()-c}}))}),E):void 0;N.set(s,{resolve:a.resolve,reject:a.reject,timeout:d,sendTime:c}),L.log({level:"info",from:j,type:"requestSent",data:{requestId:s,method:t}});const l={type:`${v.default.audioProcessor.api}/${t}`,requestId:s,...n};return K.requestsSent+=1,async function(e){const{message:t,environment:n}=e,o=JSON.stringify(t);K.charactersSent+=o.length,H<o.length&&(H=o.length);const i=await ie(n);null==i||i.write(t)}({message:l,environment:o}),null===(i=e.onRequestSent)||void 0===i||i.call(e),a.promise.then((e=>{C(o,{status:"success",endpoint:t})})).catch((e=>{const n=q.getStats();C(o,{status:"failure",endpoint:t,queue_running_size:n.running,queue_backup_size:n.queue})})),a.promise}));return{response:i.catch((e=>{e instanceof he&&!Q?(Q=!0,G+=1,ee("connectionResetDueToFailedRequest"),ie(o).then((e=>{null==e||e.end()})),me(`sendRequest() for ${t} returned server error (${e.message}), resetting connection`,n)):me(`sendRequest() cancelled or errored for ${t} (${e.message})`,n)})),asyncQueuePromise:i}}function le(e){K.messagesReceived+=1;const t=(0,m.Gu)(i.yx,e);if(t)return K.invalidMessagesReceived+=1,void s.rateLimitedLog({level:"warning",from:j,type:"ValidationError",data:{miscDataToConvertToString:e},error:(0,d.Ui)(t)});const n=e;switch(n.type){case"response":{var o;const{requestId:e,status:t,result:i}=n,s=N.get(e);if(N.delete(e),L.log({level:"info",from:j,type:"responseReceived",data:{requestId:e,response:t,time:s&&Date.now()-s.sendTime,internalProcessingTimeMs:null===(o=n.result)||void 0===o?void 0:o.internalProcessingTimeMs}}),!s)return void(K.responsesReceivedWithoutHandlers+=1);J=Date.now(),window.clearTimeout(s.timeout),"ok"===t?(K.successfulResponsesReceived+=1,s.resolve(i)):(K.unsuccessfulResponsesReceived+=1,s.reject(new he(i)));break}case"transcription":T.emit(R,n);break;case"vad":T.emit(x,n);break;case"rate_limited":T.emit(I,n);break;case"forbidden":T.emit(P,n);break;case"openai_error":T.emit(B,n)}}function ue(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var o,i;n&&s.log({level:"info",from:j,type:"audioProcessorEnd",error:{message:`SocketId: ${null==e||null===(o=e.socket)||void 0===o?void 0:o.id} Query:${null==e||null===(i=e.transport)||void 0===i?void 0:i.query}`}});V.setTimeout((()=>{void 0!==e&&e.destroy()}),0),ie.cache.clear(),ae(),n&&V.setTimeout((()=>{ie(t)}),2*h.C0)}async function ge(e){if(e&&ie.cache.has("primus_audioProcessor")){const t=await ie(e);if(t){const n={type:`${v.default.audioProcessor.api}/destroySession`,requestId:r.Il()};t.write(n),t.removeAllListeners("end"),ue(t,e,!1),(0,D.generateNewClientSessionId)()}}}class he extends Error{constructor(e){super(e),this.name="FailedAudioProcessorRequestError"}}function me(){if(A){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.info("audioProcessorInternals:",...t)}}},920939:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AudioSessionBlockWriter:()=>M,DictationManager:()=>N,Segment:()=>B,smartToggleDictation:()=>j,startDictation:()=>L,stopDictation:()=>F});n(757658),n(21703),n(348675),n(863408),n(614590),n(103462),n(823767),n(808585),n(68696);var o=n(701302),i=n(541432),s=n(76233),r=n(990038),a=n(119785),c=n(709953),d=n(742858),l=n(137231),u=n(898104),g=n(210228),h=n(415191),m=n(331282),v=n(628020),p=n(840959),f=n(798165),S=n(826842),b=n(27724),k=n(11377),w=n(17277),y=n(79016),_=n(987325),C=n(68688),D=n(701621),R=n(13682),x=n(922705),I=n(760031);const P=/([\?\!\.])\s/;class B{constructor(e,t){this.id=void 0,this.text=void 0,this.isCompleteReceived=void 0,this.transcriptions=void 0,this.id=e,this.isCompleteReceived=!!t,this.transcriptions=new Map}updateText(){let e;for(const t of this.transcriptions.values()){if("pending"===t.status)break;"complete"===t.status&&(e=t.text)}this.text=e}setTranscription(e,t){this.transcriptions.set(e,t),this.updateText()}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getText(){return this.text}isSettled(){return this.isCompleteReceived&&[...this.transcriptions.values()].every((e=>"pending"!==e.status))}}class T{constructor(e){this.blockStore=void 0,this.segments=void 0,this.isSettled=void 0;const{blockStore:t}=e;this.blockStore=t,this.segments=new Map,this.isSettled=!1}setSegment(e,t){this.segments.set(e,t)}getSegments(){return this.segments.values()}getBlockStore(){return this.blockStore}deleteSegment(e){this.segments.delete(e)}getIsSettled(){return this.isSettled}setIsSettled(e){this.isSettled=e}}class M{constructor(e){this.id=void 0,this.env=void 0,this.isCompleteReceived=void 0,this.segments=void 0,this.blockSegmentManager=void 0,this.blockSegmentManagers=void 0,this.latestSettledText=void 0;const{id:t,env:n,blockStore:o}=e,i=new T({blockStore:o});this.id=t,this.env=n,this.isCompleteReceived=!1,this.segments=new Map,this.blockSegmentManagers=new Set([i]),this.blockSegmentManager=i,this.latestSettledText=""}getEnvironment(){return this.env}getOrCreateSegment(e){const t=this.segments.get(e);if(t)return t;{const t=new B(e);return this.segments.set(e,t),this.blockSegmentManager.setSegment(e,t),t}}getBlockSegmentManager(){return this.blockSegmentManager}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getFullText(e){return[...e.values()].map((e=>e.getText())).filter((e=>!!e)).join(" ").trim()}isSettled(){return this.isCompleteReceived&&[...this.segments.values()].every((e=>e.isSettled()))}setLatestSettledText(e){this.latestSettledText=e.trim()}getIndexOfBlockSegmentManagers(e){return Array.from(this.blockSegmentManagers).indexOf(e)}addToBlockSegmentManagers(e,t){if("number"==typeof t&&t>=0&&t<this.blockSegmentManagers.size){const n=Array.from(this.blockSegmentManagers);n.splice(t,0,e),this.blockSegmentManagers=new Set(n)}else this.blockSegmentManagers.add(e)}writeToBlock(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.blockSegmentManager.getBlockStore(),n=this.blockSegmentManager.getBlockStore().getParentBlockStore();if(t&&t.isDictatableBlock()&&n){const o=new Map;for(const t of[...this.blockSegmentManager.getSegments()]){if(!e&&!t.isSettled())break;o.set(t.getId(),t)}const i=this.getFullText([...o.values()]),s=function(e){const t=e.split(P);for(let s=1;s<t.length;s++)"."!==t[s]&&"?"!==t[s]&&"!"!==t[s]||(t[s-1]+=t[s],t[s]="");const n=t.filter((function(e){return void 0!==e&&""!==e})),o=[];let i="";for(const s of n)i.length>=250&&(o.push(i.trim()),i=""),i+=` ${s}`;i.length>0&&(o.push(i.trim()),i="");return o}(this.latestSettledText?[this.latestSettledText,i].join(" "):i);if(s.length>1){const e=s.pop();for(const o of s){const{performResult:e}=A({environment:this.env,parentBlockStore:n,sibling:t,actionType:"before"}),i=new T({blockStore:e});i.setIsSettled(!0);const s=this.getIndexOfBlockSegmentManagers(this.blockSegmentManager);this.addToBlockSegmentManagers(i,s),E({environment:this.env,block:e,transcriptions:[{text:o,settled:!0}]})}[...o.values()].slice(-1).pop()&&e&&this.setLatestSettledText(e??"");for(const t of[...o.keys()])this.blockSegmentManager.deleteSegment(t)}const r=[];this.latestSettledText&&r.push({text:this.latestSettledText,settled:!0});for(const t of this.blockSegmentManager.getSegments()){const n=t.getText();n&&r.push({text:n,settled:t.isSettled()||e})}E({environment:this.env,block:this.blockSegmentManager.getBlockStore(),transcriptions:r})}}}function A(e){let{environment:t,parentBlockStore:n,sibling:o,actionType:s}=e;return g.createAndCommit({userAction:"dictationActions.createDictationBlock",environment:t,perform:e=>{const r=(null==o?void 0:o.getDictationRoleModel())??i.Ti.text;if(t.device.isMobile){const n=("before"===s?d.P8:d.aO)({environment:t,selection:o?[o]:[],createBlockItem:p.Hc[r],transaction:e,analyticsFrom:"dictation",preventSetSelection:!0});return u.NX({store:n.getBlockTitleStore()}),n}{const i=c.j4({environment:t,type:r,inMemoryRecordCache:n.inMemoryRecordCache,transaction:e,useCrdt:n.useCrdt()});return"before"===s?a.SH({parentStore:n.getContentStore(),childStore:S.G.createChildStore(n.getContentStore(),i.pointer),before:null==o?void 0:o.id,transaction:e}):a.jG({parentStore:n.getContentStore(),childStore:S.G.createChildStore(n.getContentStore(),i.pointer),after:null==o?void 0:o.id,transaction:e}),i}}})}function E(e){let{environment:t,block:n,transcriptions:o}=e;if(n.isDictatableBlock()){const e=[],i=o.filter((e=>!!e.text));for(const[t,n]of i.entries()){const o=t===i.length-1?n.text:`${n.text} `,r=n.settled?(0,s.V3y)(o):(0,s.V3y)(o,[["dut",Date.now(),w.LB]]);e.push(r)}g.createAndCommit({userAction:"dictationActions.updateDictatableBlock",environment:t,perform:o=>{if(!n)throw new Error("No block store provided.");l.sO({environment:t,store:n.getBlockTitleStore(),value:e,transaction:o}),t.device.isMobile&&u.NX({store:n.getBlockTitleStore()})}})}}function Z(e){return new Promise(((t,n)=>{try{const o=new Blob(e),i=new FileReader;i.readAsDataURL(o),i.onloadend=()=>{var e;const o=null===(e=i.result)||void 0===e?void 0:e.toString().split(",")[1];o?t(o):n(new Error("No base64Audio"))}}catch(o){n(o)}}))}function q(e,t,n){var o;if(n&&!n.pathIsDead()&&n.id!==t.id&&(null===(o=(0,f.Dg)(n))||void 0===o?void 0:o.id)===t.id){const t=n.getParentBlockStore();if(n.isEmptyDictatableBlock()&&[...x.ZP.state.audioSessionBlockWriters.values()].every((e=>e.getBlockSegmentManager().getBlockStore().id!==n.id)))return n;if(t)return A({environment:e,parentBlockStore:t,sibling:n,actionType:"after"}).performResult}return A({environment:e,parentBlockStore:t}).performResult}class N{static async getCurrentAudioBufferAsBase64(){const e=this.audioBuffer;return this.audioBuffer=new Float32Array,this.audioEncoderQueue.enqueue((()=>Z([e])))}static async getAllProcessableFramesAsBase64(e){const t=16*Math.max(1,e),n=Math.floor(this.audioBuffer.length/t);if(n>0){const e=n*t,o=this.audioBuffer.slice(0,e);return this.audioBuffer=this.audioBuffer.slice(e),this.audioEncoderQueue.enqueue((()=>Z([o])))}return!1}static getDictationAudioRecorder(e){const{environment:t}=e,n=x.ZP.state.audioRecorder;return n?(n.stop(),n):new _.hn({onDataReceived:e=>{x.TI.state&&(this.audioBuffer=new Float32Array([...this.audioBuffer,...e]),this.getAllProcessableFramesAsBase64(96).then((e=>{if(e){const n=(0,I.PN)((0,I._A)(t.currentUser.id));(0,h.KW)({base64Audio:e,environment:t,language:n}).catch((()=>{}))}})).catch((()=>{})))},onStop:e=>{F({environment:t,error:e})}})}static get dictationIsActive(){return Boolean(this.startController&&!this.startController.signal.aborted)}static async smartToggleDictation(e){var t;const n=(0,v.np)();return this.dictationIsActive&&(null===(t=x.ZP.state.pageBlock)||void 0===t?void 0:t.id)===(null==n?void 0:n.id)?this.stopDictation(e):this.startDictation(e)}static async startDictation(e){try{await this.stopDictation({environment:e.environment}),this.startController=new AbortController;const n=this.startController.signal;x.ZP.setState({...x.ZP.state,loading:!0});const i=e.pageBlock??(0,v.np)(),{environment:s}=e;let r;if(e.preCreateDictationBlock&&i){const e=A({environment:s,parentBlockStore:i,sibling:void 0,actionType:"after"}).performResult;r=e,await o.default.afterNextFlush((()=>{u.N_({store:e.getBlockTitleStore()})}))}const a=(0,h.wW)();e.from&&(0,k.EE)(e.environment,{dictation_session_id:a,from:e.from});const c=(null==i?void 0:i.isPageBlock())||(null==i?void 0:i.isCollectionViewPageWithContent());if(!i||!c||!(0,C.d)())throw new Error("Page is not dictatable.");const d=this.getDictationAudioRecorder(e);O.start();try{const{environment:t}=e;if(await d.start(),R.ZP.setState(R.pY),n.aborted)throw new Error("start dictation aborted");const o=b.default.state.stores.slice(-1).pop();await(0,m.a_)(e.environment),x.ZP.setState({...x.ZP.state,audioRecorder:d,enabled:!0,talking:!1,pageBlock:i,block:r??q(t,i,o),environment:t}),(0,k.tx)(t,{dictation_session_id:a})}catch(t){if(!n.aborted)try{const t=await R.ZP.checkPermissions();(0,k.Gf)(e.environment,{type:"mic_permissions",dictation_session_id:a,reason:t})}catch(t){}d.destroy()}}catch{this.stopDictation({environment:e.environment})}finally{x.ZP.setState({...x.ZP.state,loading:!1})}}static async stopDictation(e){if(this.startController&&!this.startController.signal.aborted){this.startController.abort();const{environment:n,error:o,from:i}=e,s=(0,h.wW)();i&&(0,k.Ue)(n,{dictation_session_id:s,from:i});const r=x.ZP.state.audioRecorder,a=x.ZP.state.enabled;x.ZP.setState({...x.ZP.state,audioRecorder:void 0,enabled:!1,loading:!1,pageBlock:void 0,block:void 0}),null==r||r.destroy();try{o instanceof y.cq?((0,k.Gf)(n,{type:"throttle",dictation_session_id:s}),(0,D.Sc)()):o instanceof y.c2?((0,k.Gf)(n,{type:"missing_user_or_space",dictation_session_id:s,reason:o.message}),(0,D.CZ)()):o instanceof y.Ay?(0,k.Gf)(n,{type:"mic_permissions",dictation_session_id:s,reason:R.ZP.state}):o instanceof y.if?((0,k.Gf)(n,{type:"forbidden",dictation_session_id:s}),(0,D.CZ)()):(o instanceof y.LN||o instanceof Error)&&(0,D.CZ)(),await(0,m.y0)(n)}catch(t){}finally{O.stop();const e=x.ZP.state.audioSessionBlockWriters;let t=!1;for(const n of e.values())n.writeToBlock(!0),e.delete(n.getId()),t=!0;t&&x.ZP.emit(),a&&(0,k.DC)(n,{dictation_session_id:s})}}}}async function j(e){return N.smartToggleDictation(e)}async function L(e){return N.startDictation(e)}async function F(e){const{environment:t,error:n,from:o}=e;return N.stopDictation({environment:t,error:n,from:o})}N.startController=void 0,N.audioBuffer=new Float32Array,N.audioEncoderQueue=new r.z(1);class O{constructor(){if(O.instance)return O.instance;O.instance=this}static start(){this.listening||(this.listening=!0,m.JD.on(m.Oz,O.processTranscriptionResult),m.JD.on(m.PH,O.processVadEvent),m.JD.on(m._r,O.processRateLimitEvent),m.JD.on(m.m7,O.processForbiddenEvent),m.JD.on(m.pv,O.processOpenAIErrorEvent))}static stop(){this.listening&&(this.listening=!1,m.JD.off(m.Oz,O.processTranscriptionResult),m.JD.off(m.PH,O.processVadEvent),m.JD.off(m._r,O.processRateLimitEvent),m.JD.off(m.m7,O.processForbiddenEvent),m.JD.off(m.pv,O.processOpenAIErrorEvent))}static processOpenAIErrorEvent(e){if(429===e.status){const{environment:t}=x.ZP.state;F({environment:t,error:new y.LN(e.message,e.status)})}}static processForbiddenEvent(e){const{environment:t}=x.ZP.state;F({environment:t,error:new y.if("Not eligible for dictation")})}static processRateLimitEvent(e){const{environment:t}=x.ZP.state;F({environment:t,error:new y.cq("Audio usage limit reached")})}static processVadEvent(e){x.ZP.setState({...x.ZP.state,talking:e.talking})}static processTranscriptionResult(e){const{audioSessionId:t,segmentId:n,isSegmentComplete:o,isAudioSessionComplete:i}=e,{enabled:s,pageBlock:r,audioSessionBlockWriters:a,environment:c,block:d}=x.ZP.state;let l=!1;if(!a.has(t)&&c&&s){const e=r?q(c,r,d):void 0;if(e){const n=new M({id:t,env:c,blockStore:e});a.set(t,n),l=!0,x.ZP.setState({...x.ZP.state,block:e})}else F({environment:c})}const u=a.get(t);if(u){u.setIsCompleteReceived(i);const t=u.getOrCreateSegment(n);t.setIsCompleteReceived(o),t.setTranscription(e.transcription.id,e.transcription)}for(const h of a.values())h.writeToBlock();for(const h of[...a.values()].filter((e=>e.isSettled()))){var g;a.delete(h.getId()),l=!0,s&&c&&r&&(null===(g=x.ZP.state.block)||void 0===g?void 0:g.id)===h.getBlockSegmentManager().getBlockStore().id&&x.ZP.setState({...x.ZP.state,block:q(c,r,x.ZP.state.block)})}l&&x.ZP.emit()}}O.instance=void 0,O.listening=!1},11377:(e,t,n)=>{"use strict";n.d(t,{DC:()=>a,EE:()=>i,Gf:()=>c,Ue:()=>s,qZ:()=>d,tx:()=>r});var o=n(730459);function i(e,t){e&&o.K4(e,"dictation_modal_open",t)}function s(e,t){e&&o.K4(e,"dictation_modal_close",t)}function r(e,t){e&&o.K4(e,"dictation_start",t)}function a(e,t){e&&o.K4(e,"dictation_end",t)}function c(e,t){e&&o.K4(e,"dictation_error",t)}function d(e,t){e&&o.K4(e,"update_dictation_language",t)}},79016:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>o,LN:()=>r,c2:()=>a,cq:()=>i,if:()=>s});n(21703);class o extends Error{constructor(e){super(e),this.name="DictationAudioRecorderFailedError"}}class i extends Error{constructor(e){super(e),this.name="DictationRateLimitError"}}class s extends Error{constructor(e){super(e),this.name="DictationForbiddenError"}}class r extends Error{constructor(e,t){super(e),this.status=void 0,this.status=t,this.name="DictationOpenAIError"}}class a extends Error{constructor(e){super(e),this.name="DictationMissingUserOrSpaceError"}}},987325:(e,t,n)=>{"use strict";n.d(t,{hn:()=>g,oF:()=>u});var o=n(59391);n(348675),n(863408),n(614590),n(103462),n(823767),n(808585),n(68696);class i{constructor(e,t){this._inputSampleRate=void 0,this._outputSampleRate=void 0,this._inputSampleRate=e,this._outputSampleRate=t}downsample(e){return this.downSampleAudioFrame(e,this._inputSampleRate,this._outputSampleRate)}downSampleAudioFrame(e,t,n){if(n===t||n>t)return e;const o=t/n,i=Math.round(e.length/o),s=new Float32Array(i);let r=0,a=0;for(;a<i;){const t=Math.round((a+1)*o);let n=0,i=0;for(;r<t&&r<e.length;)n+=e[r++],i++;s[a++]=n/i}return s}}var s=n(79016),r=n(749650),a=n(193919),c=n(13682),d=n(979546),l=n(439449);const u="ms_change";class g{constructor(e){this._mediaStream=void 0,this._emitter=void 0,this.recorder=void 0,this.onDataReceived=void 0,this.onStop=void 0,this.startController=void 0,this.handleDeviceChange=async()=>{var e;const t=null===(e=this.mediaStream)||void 0===e||null===(e=e.getAudioTracks()[0])||void 0===e?void 0:e.getSettings(),n=this.getPreferredOrDefaultDevice();if(!t||n&&(n.deviceId!==t.deviceId||n.groupId!==t.groupId)){this.stop(!1);try{await this.start()}catch{this.destroy()}}},this._emitter=(0,o.Z)(),this.recorder=new h,this.onDataReceived=e.onDataReceived,this.onStop=e.onStop}get emitter(){return this._emitter}set mediaStream(e){var t;if(this._mediaStream)for(const o of this._mediaStream.getTracks())o.stop();if(e)for(const o of e.getTracks())o.addEventListener("ended",(async()=>{if(e.getTracks().every((e=>"ended"===e.readyState))){"allowed"!==await c.ZP.checkPermissions()&&this.stop(!0,new s.Ay)}}));const n=null==e||null===(t=e.getAudioTracks()[0])||void 0===t?void 0:t.getSettings();a.Z.setState(d.UR.state.find((e=>e.deviceId===(null==n?void 0:n.deviceId)))),this._mediaStream=e,this._emitter.emit(u)}get mediaStream(){return this._mediaStream}getPreferredOrDefaultDevice(){var e;return(null===(e=d.UR.state)||void 0===e?void 0:e.find((e=>{var t;return e.deviceId===(null===(t=l.Z.state)||void 0===t?void 0:t.deviceId)})))??d.UR.state[0]}async start(){if(void 0===this.startController||this.startController.signal.aborted){this.startController=new AbortController;const e=this.startController.signal,t=this.getPreferredOrDefaultDevice(),n=(0,r.G)();if(this.mediaStream=await n.getUserMedia({audio:{deviceId:t?{exact:t.deviceId}:void 0,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1}}),e.aborted)return void(this.mediaStream=void 0);if(await this.recorder.record(this.mediaStream,(t=>{e.aborted||this.onDataReceived(t)}),16e3),e.aborted)return void this.recorder.releaseMediaResources();l.Z.addListener(this.handleDeviceChange),d.UR.addListener(this.handleDeviceChange)}}stop(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;void 0===this.startController||this.startController.signal.aborted||(this.startController.abort(),this.recorder.releaseMediaResources(),this.mediaStream=void 0,e&&this.onStop&&this.onStop(t),l.Z.removeListener(this.handleDeviceChange),d.UR.removeListener(this.handleDeviceChange))}destroy(){l.Z.removeListener(this.handleDeviceChange),d.UR.removeListener(this.handleDeviceChange),this.stop()}}class h{constructor(){this._audioWorkletNode=void 0,this._sourceNode=void 0,this._audioContext=void 0}set sourceNode(e){this._sourceNode&&this._sourceNode.disconnect(),this._sourceNode=e}set audioWorkletNode(e){this._audioWorkletNode&&this._audioWorkletNode.disconnect(),this._audioWorkletNode=e}set audioContext(e){this._audioContext&&this._audioContext.close(),this._audioContext=e}get audioContext(){return this._audioContext}async record(e,t,o){if(this.releaseMediaResources(),this.audioContext=(0,r.k)(o),Boolean(this.audioContext.audioWorklet))try{const s=new i(this.audioContext.sampleRate,o),r=this.audioContext.createMediaStreamSource(e);await this.audioContext.audioWorklet.addModule(new URL(n(240366),n.b));const a=new AudioWorkletNode(this.audioContext,"pcm-processor");a.port.onmessage=e=>{if(e.data){const n=e.data,o=s.downsample(n);t(o)}},r.connect(a),this._audioWorkletNode=a,this._sourceNode=r}catch{console.info("unable to create worklet"),this.releaseMediaResources()}else this.releaseMediaResources()}releaseMediaResources(){this.sourceNode=void 0,this.audioWorkletNode=void 0,this.audioContext=void 0}}},749650:(e,t,n)=>{"use strict";n.d(t,{G:()=>o,k:()=>i});n(21703);function o(){const e=navigator.mediaDevices;if(e instanceof MediaDevices)return e;throw new Error("Media devices unavailable in current context.")}function i(e){const t=window.AudioContext||window.webkitAudioContext||!1;var n;if(Boolean(t))return new t({...(null===(n=navigator)||void 0===n||null===(n=n.mediaDevices)||void 0===n?void 0:n.getSupportedConstraints().sampleRate)&&{sampleRate:e}});throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}},701621:(e,t,n)=>{"use strict";n.d(t,{CZ:()=>v,Sc:()=>m,fB:()=>h});n(667294);var o=n(709291),i=n(164964),s=n(433929),r=n(17277),a=n(785893);const c=(0,o.defineMessages)({dictationError:{id:"dictation.generic.snackbar.error",defaultMessage:"Dictation failed. Please try again."}});function d(){return(0,a.jsx)(o.FormattedMessage,{defaultMessage:"No microphone permission. Allow access to your microphone in system settings",id:"dictation.permission.microphone.snackbar.error"})}function l(){return(0,a.jsx)(o.FormattedMessage,{defaultMessage:"No microphone available. Connect your microphone in system settings",id:"dictation.unavailable.microphone.snackbar.error"})}function u(){return(0,a.jsx)(o.FormattedMessage,{defaultMessage:"An unknown error occurred when trying to access the microphone.",id:"dictation.permission.unknown.snackbar.error"})}function g(){return(0,a.jsx)(o.FormattedMessage,{defaultMessage:"Audio usage limit reached. Try again later.",id:"dictation.usage.snackbar.error"})}r.Zh,r.gg,r.oB;function h(e){e===r.Zh?i.lB({item:{label:(0,a.jsx)(d,{})}}):e===r.gg?i.lB({item:{label:(0,a.jsx)(l,{})}}):i.lB({item:{label:(0,a.jsx)(u,{})}})}function m(){i.oV({label:(0,a.jsx)(g,{})})}function v(){i.oV({label:s.default.formatMessage(c.dictationError)})}},193919:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var o=n(749085);class i extends o.default{constructor(){super()}getInitialState(){}}const s=new i},13682:(e,t,n)=>{"use strict";n.d(t,{ZP:()=>m,pY:()=>c});n(21703);var o=n(749085),i=n(653965),s=n(749650),r=n(701621);const a="initial",c="allowed",d="denied",l="no_devices",u="insecure_context",g="unknown_error";class h extends o.default{async checkPermissions(){const e=await h.checkAudioPermissionsThrottled();return this.setState(e),e}getInitialState(){return window.isSecureContext?a:u}}h.checkAudioPermissionsThrottled=(0,i.P2)((async()=>{if(!window.isSecureContext)return u;try{const e=(0,s.G)();return function(e){for(const t of e.getTracks())t.stop()}(await e.getUserMedia({video:!1,audio:!0})),c}catch(e){if(e instanceof Error)switch(e.name){case"NotAllowedError":return(0,r.fB)(d),d;case"NotFoundError":case"OverconstrainedError":return(0,r.fB)(l),l}return(0,r.fB)(g),g}}),1e3);const m=new h},979546:(e,t,n)=>{"use strict";n.d(t,{TZ:()=>g,UR:()=>u,ZP:()=>h});n(757658);var o=n(14577),i=n(749085),s=n(749650),r=n(193919),a=n(13682),c=n(439449);class d extends i.default{async updateMediaDevices(){try{const e=await async function(){const e=(0,s.G)();return(await e.enumerateDevices()).reduce(((e,t)=>{if(t.kind&&t.label&&t.deviceId&&t.groupId)switch(t.kind){case"videoinput":e.videoInput.push(t);break;case"audioinput":e.audioInput.push(t);break;case"audiooutput":e.audioOutput.push(t)}return e}),{videoInput:[],audioInput:[],audioOutput:[]})}();this.setState(e)}catch{}}constructor(){super();try{(0,s.G)().addEventListener("devicechange",(()=>{this.updateMediaDevices()}))}catch{}a.ZP.addListener((()=>{this.updateMediaDevices()}))}getInitialState(){return{videoInput:[],audioInput:[],audioOutput:[]}}}const l=new d,u=new o.Z((()=>{var e,t;return(null===(e=l.state)||void 0===e||null===(e=e.audioInput)||void 0===e||null===(t=e.filter)||void 0===t?void 0:t.call(e,(e=>null==e?void 0:e.label)))??[]}),{debugName:"AudioInputDevicesStore"}),g=new o.Z((()=>{var e;const t=r.Z.state,n=null===(e=c.Z.state)||void 0===e?void 0:e.label,o=u.state.find((e=>e.label===n));return t||(o||u.state[0])}),{debugName:"SelectedAudioInputDeviceStore"}),h=l},439449:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var o=n(749085);class i extends o.default{constructor(){super()}getInitialState(){}}const s=new i},760031:(e,t,n)=>{"use strict";n.d(t,{PN:()=>g,TG:()=>u,Yg:()=>f,_A:()=>S});n(346314);var o=n(749085),i=n(742741),s=n(915157),r=n(372933),a=n(619584),c=n(415191),d=n(80444),l=n(11377);function u(){return Object.entries(i.jH)}function g(e){return i.jH[e][1]}function h(e){switch(e){case"en-US":default:return"English";case"de-DE":return"German";case"ko-KR":return"Korean";case"zh-CN":case"zh-TW":return"Chinese";case"ja-JP":return"Japanese";case"es-ES":case"es-LA":return"Spanish";case"pt-BR":return"Portuguese";case"fr-FR":return"French";case"da-DK":return"Danish";case"fi-FI":return"Finnish";case"nb-NO":return"Norwegian";case"nl-NL":return"Dutch";case"sv-SE":return"Swedish"}}class m extends o.default{constructor(){super(),this.lastLocalStorageRetrieval=void 0}syncLocalStorageIfNecessary(e){if(!this.lastLocalStorageRetrieval||e!==this.lastLocalStorageRetrieval[0]||Date.now()-this.lastLocalStorageRetrieval[1]>30*a.C0){this.lastLocalStorageRetrieval=[e,Date.now()];const n=s.Z.get({userId:e,key:p});if(Object.hasOwn(i.jH,n))this.state!==n&&this.setState(n);else{var t;const n=h((null===(t=d.default.state.currentUserSettingsStore)||void 0===t||null===(t=t.getSettings())||void 0===t?void 0:t.preferred_locale)??r.al);n!==this.state&&this.setState(n),s.Z.set({userId:e,key:p,value:this.state})}}}getInitialState(){var e;return h((null===(e=d.default.state.currentUserSettingsStore)||void 0===e||null===(e=e.getSettings())||void 0===e?void 0:e.preferred_locale)??r.al)}}const v=new m,p="DictationLanguage";function f(e,t){(0,l.qZ)(e,{from_language:v.state,to_language:t,dictation_session_id:(0,c.wW)()}),v.setState(t),s.Z.set({userId:e.currentUser.id,key:p,value:t})}function S(e){return v.syncLocalStorageIfNecessary(e),v.state}},742741:(e,t,n)=>{"use strict";n.d(t,{jH:()=>i,yx:()=>d});var o=n(212847);const i={English:["English","en"],Chinese:["Chinese","zh"],Spanish:["Spanish","es"],French:["French","fr"],German:["German","de"],Japanese:["Japanese","ja"],Korean:["Korean","ko"],Portuguese:["Portuguese","pt"],Russian:["Russian","ru"],Thai:["Thai","th"],Vietnamese:["Vietnamese","vi"],Danish:["Danish","da"],Finnish:["Finnish","fi"],Norwegian:["Norwegian","no"],Dutch:["Dutch","nl"],Swedish:["Swedish","sv"]},s=o.union([o.number(),o.string(),o.boolean(),o.isNull(),o.array(o.string())]),r=o.undefinable(s),a=(o.union([s,o.record(o.string(),s)]),o.union([r,o.record(o.string(),r)])),c=(o.union([a,o.record(o.string(),a)]),o.without(o.without(o.nonEmpty(o.string()),"{"),"}"),o.union([o.object({required:{id:o.string(),status:o.literal("pending"),audioDuration:o.number()},optional:{}}),o.object({required:{id:o.string(),status:o.literal("complete"),text:o.string(),audioDuration:o.number()},optional:{}}),o.object({required:{id:o.string(),status:o.literal("error"),reason:o.string(),audioDuration:o.number()},optional:{}}),o.object({required:{id:o.string(),status:o.literal("ignore"),audioDuration:o.number()},optional:{}})])),d=o.union([o.object({required:{type:o.literal("transcription"),audioSessionId:o.string(),segmentId:o.string(),transcription:c,isSegmentComplete:o.boolean(),isAudioSessionComplete:o.boolean()},optional:{}}),o.object({required:{type:o.literal("response"),status:o.literals("ok","error"),requestId:o.string(),result:o.any()},optional:{}}),o.object({required:{type:o.literal("vad"),talking:o.boolean()},optional:{}}),o.object({required:{type:o.literal("rate_limited"),status:o.literal(429),name:o.literal("UserRateLimitResponse"),message:o.string()},optional:{}}),o.object({required:{type:o.literal("forbidden"),status:o.literal(403),name:o.literal("ForbiddenError"),message:o.string()},optional:{}}),o.object({required:{type:o.literal("openai_error"),message:o.string()},optional:{status:o.number()}})]);o.object({required:{base64Audio:o.string(),userId:o.string(),spaceId:o.string()},optional:{language:o.literals(...Object.values(i).map((e=>{let[t,n]=e;return n})))}}),o.object({required:{},optional:{}}),o.object({required:{userId:o.string(),spaceId:o.string()},optional:{language:o.literals(...Object.values(i).map((e=>{let[t,n]=e;return n})))}}),o.object({required:{},optional:{}}),o.object({required:{},optional:{}}),o.object({required:{},optional:{}}),o.object({required:{},optional:{}}),o.object({required:{},optional:{}})},346314:(e,t,n)=>{n(82109)({target:"Object",stat:!0},{hasOwn:n(892597)})},240366:(e,t,n)=>{"use strict";e.exports=n.p+"dbc10b469ee58d20.js"}}]);