"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[47687],{18533:(e,t,n)=>{n.d(t,{Z:()=>b});var o=n(667294),i=n(800480),r=n(886628),s=n(568626),l=n(653965),a=n(552629),d=n(552275),u=n(231945),c=n(478140),p=n(632163),m=n(953437),h=n(672495),f=n(460709),x=n(98742),g=n(61766),v=n(694166),y=n(785893);const b=function(e){let{icon:t,title:n,selectedKey:b,onChange:k,onClick:S,popupStyle:I,menuItemOptionsStyle:C,disabled:M,collectionContextStore:w,openButtonPopup:j,hideCheck:T,children:F,disableParentClose:A,...V}=e;const E=(0,i.Fy)(),R="options"in V?V.options:l.xH(V.sections),P=R.find((e=>l.Xy(e.key,b))),B=(0,r.qz)(void 0,g.Z),N=(0,r.Kw)(B);return(0,o.useEffect)((()=>{w&&j&&(B.setState({...B.state,open:j}),w.settingsStore.setState({...w.settingsStore.state,openButtonPopup:void 0})),P||s.log({level:"error",from:"CollectionSettingsPickListMenuItem",type:"InvalidSelectedItem",error:(0,a.Ui)("Selected key is invalid.")})})),(0,y.jsx)(u.ZP,{popupType:E.isMobile?m.kQ.SlideUp:m.kQ.Popup,alignmentToOrigin:u.vR.End,placementToOrigin:u.pO.Bottom,style:I,originGap:0,buttonPopupStore:B,disabled:M,onClick:S,renderOrigin:e=>(0,y.jsx)(v.Z,{title:n,showChevron:!0,right:null==P?void 0:P.title,rotateChevron:N.open,disabled:M,icon:t,...(0,x.Z)(e,V)}),render:e=>{let t;t=E.isMobile?{menuType:f.og.ActionSheet}:{menuType:f.og.Popup,width:250};const n=(t,n)=>({key:n,render:e=>(0,y.jsx)(d.Z,{...e,disabled:!1,title:t.title,icon:t.icon,caption:t.caption,captionStyle:t.captionStyle,inline:t.captionInline,spacerStyle:t.inlineSpacerStyle,body:t.body,style:C,checkState:!T&&l.Xy(t.key,b)}),action:()=>{k(t.key,e),A||e.close()}}),o="sections"in V?V.sections.map(((e,t)=>({key:t,render:e=>(0,y.jsx)(h.Z,{enableActionSheetTitle:!0,topBorder:t>0,...e}),items:l.oA(e.map(n))}))):[{key:0,render:e=>(0,y.jsx)(h.Z,{enableActionSheetTitle:!0,...e}),items:l.oA(R.map(n))}];return(0,y.jsxs)(c.Z,{...t,children:[(0,y.jsx)(p.Z,{type:p.i.Vertical,sections:o,initialFocus:0}),F||null]})}})}},887986:(e,t,n)=>{n.d(t,{Z:()=>Pt});n(757658);var o=n(667294),i=n(800480),r=n(886628),s=n(724405),l=n(773717),a=n(150610),d=n(335102),u=n(966673),c=n(654497),p=n(76233),m=n(709291),h=n(653965),f=n(940470),x=n(401898),g=n(137810),v=n(898104),y=n(768657),b=n(268056),k=n(80444),S=n(924666),I=n(332856),C=n(203386),M=n(471924),w=n(598151),j=n(307032),T=n(454642),F=n(547307),A=n(137231),V=n(210228);var E=n(11751),R=n(438305),P=n(626174),B=n(689024),N=n(164921),D=n(301743),O=n(291839),Z=n(707124),U=n(785893);function G(e){const{formulaAssistantStore:t,onStop:n,onSubmit:i}=e,l=(0,m.useIntl)(),{prompt:a,inputMode:d}=(0,r.VK)((()=>{const{state:e}=t;return{prompt:e.prompt,inputMode:e.inputMode}}),[t]),u=(0,o.useCallback)((()=>{i(a)}),[i,a]),c=(0,o.useCallback)((e=>{t.update((t=>({...t,prompt:e})))}),[t]),p=(0,s.yK)((e=>({icon:{height:16,width:16,fill:e.icon.primary},wrapper:{borderTop:`1px solid ${e.stroke.deemphasized}`,background:e.popoverBackground}})),[]);return(0,U.jsx)(D.Z,{capture:!0,debugName:"FormulaAssistantInput",priority:1,children:(0,U.jsxs)(B.jX,{direction:"row",align:"top-left",gap:6,padding:"9px 12px",style:p.wrapper,children:[(0,U.jsx)(B.jX,{width:20,height:28,align:"center",children:(0,E.t)(p.icon)}),(0,U.jsx)(B.jX,{width:"fill",children:"busy"===d?(0,U.jsx)(K,{}):(0,U.jsx)(Z.q,{styleName:"Body-14px/Regular",children:(0,U.jsx)(R.g,{onDismiss:()=>{},query:a,setQuery:c,onSubmit:u,submitOnEnter:!0,inputPlaceholder:l.formatMessage(W(d)),selectAll:!1,style:{minHeight:"auto",marginTop:1}})})}),"busy"===d?(0,U.jsx)(_,{onStop:n}):(0,U.jsx)(L,{onSubmit:u,isEnabled:a.length>0})]})})}function _(e){const{onStop:t}=e,n=(0,m.useIntl)(),{isPhone:o}=(0,i.Fy)(),r=(0,s.yK)((e=>({lightweightButton:{display:"flex",alignItems:"baseline",justifyContent:"center",fontSize:14,padding:"5px 8px",borderRadius:4,color:e.mediumTextColor,height:32,marginTop:2},keyboardShortcut:{textTransform:"uppercase",fontWeight:500,fontSize:11,marginLeft:6,color:e.lightTextColor,display:o?"none":void 0}})),[o]);return(0,U.jsx)(C.Z,{debugName:"FormulaAssistantInput_StopButton",capture:!0,onEnter:t,onEsc:t,priority:1,children:(0,U.jsx)(B.jX,{width:"hug",height:28,align:"center",children:(0,U.jsxs)(N.Z,{style:r.lightweightButton,onClick:t,children:[n.formatMessage(H.cancel),(0,U.jsx)("span",{style:r.keyboardShortcut,children:n.formatMessage(H.cancelShortcut)})]})})})}function L(e){const{isEnabled:t,onSubmit:n}=e;return(0,U.jsx)(B.jX,{width:"hug",height:28,align:"center",children:(0,U.jsx)(P.O,{onSubmit:n,canSend:t})})}function K(){const e=(0,m.useIntl)();return(0,U.jsxs)(B.jX,{direction:"row",gap:6,height:28,align:"center-left",children:[(0,U.jsx)(Z.q,{styleName:"Body-14px/Regular",colorName:"secondary",children:e.formatMessage(H.assistantIsBusy)}),(0,U.jsx)(O.Z,{isTriColored:!0})]})}function W(e){switch(e){case"initial":return H.initialPlaceholder;case"followUp":case"busy":return H.subsequentPlaceholder;default:(0,x.t1)(e)}}const H=(0,m.defineMessages)({cancel:{id:"formulaAssistantInput.cancel",defaultMessage:"Cancel"},cancelShortcut:{id:"formulaAssistantInput.cancelShortcut",defaultMessage:"esc"},initialPlaceholder:{id:"formulaAssistantInput.initialPlaceholder",defaultMessage:"What do you want the formula to do?"},subsequentPlaceholder:{id:"formulaAssistantInput.subsequentPlaceholder",defaultMessage:"What do you want to do next?"},assistantIsBusy:{id:"formulaAssistantInput.assistantIsBusy",defaultMessage:"Notion AI is writing"}});var z=n(749085);class X extends z.default{constructor(){super(...arguments),this.hideAssistant=()=>{this.update((e=>({...e,isAssistantVisible:!1})))},this.toggleAssistantVisible=()=>{this.update((e=>({...e,isAssistantVisible:!e.isAssistantVisible})))},this.didBeginRequest=()=>{this.update((e=>({...e,inputMode:"busy"})))},this.didFinishRequest=()=>{this.update((e=>({...e,prompt:"",inputMode:"followUp"})))}}getInitialState(){return{id:(0,j.ZP)(),inputMode:"initial",isAssistantVisible:!1,prompt:""}}}var q=n(12396),$=n(984619),Q=n(173110),Y=n(889679),J=n(877097);const ee={true:{name:"true",type:{type:"checkbox"},description:J.Gw.true,examples:[{input:"true"},{input:[(0,Y.h0)("Checked"),[" == true"]]}]},false:{name:"false",type:{type:"checkbox"},description:J.Gw.false,examples:[{input:"false"},{input:[(0,Y.h0)("Checked"),[" == false"]]}]},and:{name:"and",type:{type:"checkbox"},description:J.Gw.and,examples:[{input:"3 > 2 and 2 > 3",output:"false"},{input:[(0,Y.h0)("Naughty"),[" && "],(0,Y.h0)("Nice")]}]},or:{name:"or",type:{type:"checkbox"},description:J.Gw.or,examples:[{input:"3 > 2 or 2 > 3",output:"true"},{input:[(0,Y.h0)("Naughty"),[" || "],(0,Y.h0)("Nice")]}]},not:{name:"not",type:{type:"checkbox"},description:J.Gw.not,examples:[{input:"not true",output:"false"},{input:"not (2 > 3)",output:"true"},{input:[["!"],(0,Y.h0)("Checked")]}]},"+":{name:"+",type:{type:"number"},description:J.Gw["+"],examples:[{input:"3 + 2",output:"5"},{input:"add(-1, 2)",output:"1"}]},"-":{name:"-",type:{type:"number"},description:J.Gw["-"],examples:[{input:"3 - 2",output:"1"},{input:"subtract(-1, 2)",output:"-3"}]},"*":{name:"*",type:{type:"number"},description:J.Gw["*"],examples:[{input:"3 * 2",output:"6"},{input:"multiply(-1, 2)",output:"-2"}]},"/":{name:"/",type:{type:"number"},description:J.Gw["/"],examples:[{input:"3 / 2",output:"1.5"},{input:"divide(-1, 2)",output:"-0.5"}]},"%":{name:"%",type:{type:"number"},description:J.Gw["%"],examples:[{input:"3 % 2",output:"1"},{input:"mod(-1, 2)",output:"-1"}]},"^":{name:"^",type:{type:"number"},description:J.Gw["^"],examples:[{input:"3 ^ 2",output:"9"},{input:"pow(-1, 2)",output:"1"}]},"==":{name:"==",type:{type:"checkbox"},description:J.Gw["=="],examples:[{input:"3 == 2",output:"false"},{input:'equal("A", "A")',output:"true"}]},"!=":{name:"!=",type:{type:"checkbox"},description:J.Gw["!="],examples:[{input:"3 != 2",output:"true"},{input:'unequal("A", "A")',output:"false"}]},">":{name:">",type:{type:"checkbox"},description:J.Gw[">"],examples:[{input:"3 > 2",output:"true"},{input:'now() > parseDate("2040-01-01")',output:"false"}]},"<":{name:"<",type:{type:"checkbox"},description:J.Gw["<"],examples:[{input:"3 < 2",output:"false"},{input:'now() < parseDate("2040-01-01")',output:"true"}]},">=":{name:">=",type:{type:"checkbox"},description:J.Gw[">="],examples:[{input:"3 >= 2",output:"true"},{input:'now() >= parseDate("2040-01-01")',output:"false"}]},"<=":{name:"<=",type:{type:"checkbox"},description:J.Gw["<="],examples:[{input:"3 <= 2",output:"false"},{input:'now() <= parseDate("2040-01-01")',output:"true"}]}};var te=n(775e3),ne=n(656505),oe=n(433929),ie=n(460709),re=n(229798),se=n(73657),le=n(552275),ae=n(231945),de=n(478140),ue=n(828992),ce=n(632163),pe=n(840721),me=n(672495),he=n(842875),fe=n(875553),xe=n(820852),ge=n(882883),ve=n(744805),ye=n(800893),be=n(95477),ke=n(296994),Se=n(360682),Ie=n(924990),Ce=n(162619),Me=n(455227),we=n(277907),je=n(319385),Te=n(573063);const Fe=o.memo((function(e){let{infoHelper:t,getRecordModel:n,style:o}=e;const i=t;if(void 0===(null==i?void 0:i.kind))return null;switch(i.kind){case Q.x2.Token:return(0,U.jsx)(Ee,{completion:i,getRecordModel:n,style:o});case Q.x2.LibraryFunction:{const e=!(null==t||!t.calledFromUnifiedFunctionProperty),r=function(e,t){if(t&&void 0!==e.syntax[1])return e.syntax[1];return e.syntax[0]}(i.libraryFunction,e),s=function(e,t){if(t&&void 0!==e.examples[1])return e.examples[1];return e.examples[0]}(i.libraryFunction,e),l=i.libraryFunction.returnType;return(0,U.jsx)(Ve,{icon:_e("function"==typeof l?l([]).type:l.type),name:r,description:oe.default.formatMessage(i.libraryFunction.description),examples:s.length>0?s.map(((e,t)=>(0,U.jsx)(Ae,{example:e,getRecordModel:n},t))):void 0,style:o})}case Q.x2.Binding:var r;return i.text===Q.GV?(0,U.jsx)(Ve,{icon:_e(i.type.type),name:i.text,description:oe.default.formatMessage(Ne.currentValueDescription),style:o}):i.text===Q.WY?(0,U.jsx)(Ve,{icon:_e(i.type.type),name:i.text,description:oe.default.formatMessage(Ne.currentIndexDescription),style:o}):(0,U.jsx)(Ve,{icon:_e(i.type.type),name:i.text,description:oe.default.formatMessage("array"===(null==i||null===(r=i.type)||void 0===r?void 0:r.type)?Ne.listVariableType:Ne.variableType),style:o});case Q.x2.Builtin:{const e=ee[i.builtin];return(0,U.jsx)(Ve,{icon:_e(e.type.type),name:e.name,description:oe.default.formatMessage(e.description),examples:e.examples.length>0?e.examples.map(((e,t)=>(0,U.jsx)(Ae,{example:e,getRecordModel:n},t))):void 0,style:o})}default:return(0,x.t1)(i)}}));function Ae(e){let{example:t,getRecordModel:n}=e;const l=(0,we.XJ)(ke.FF.prismjs),a=(0,Se.kw)(),d=(0,i.O7)(),{device:u}=d,c=(0,r.VK)((()=>{var e;return null===(e=k.default.state.currentSpaceStore)||void 0===e?void 0:e.id}),[]),f=(0,s.Fg)(),x=(0,m.useIntl)(),g=(0,r.VK)((()=>Ie.Z.state),[]),v=(0,r.VK)((()=>{var e;const o=document.createElement("div"),i="string"!=typeof t.input?p.QaF(t.input):t.input,r=(null===(e=l.value)||void 0===e?void 0:e.highlight(`${i}`,l.value.languages[xe.PrismLanguages.notion],xe.PrismLanguages.notion))??"";o.innerHTML=Me.g7(r);const s=h.oA(Array.from(o.childNodes).map(Pe)),m="string"==typeof t.input?[[t.input],[" = "]]:t.input.concat([[" = "]]),v=Me.kF(m,h.oA(s)),y=m.map(p.hDy).map(((e,t)=>ve.fn({annotations:e,theme:f,getRecordModel:n,spaceId:c})));return v.map(((e,t)=>{const o=y[e.textTokenIndex],i=m[e.textTokenIndex];return p.km_(i)?(0,ve.$i)({args:{textValue:{value:m,spaceId:c},getRecordModel:n,getRecordRole:()=>{},disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,he.r)(),disabled:!1,isAndroid:u.isAndroid,isSafariOrIOS:u.isSafari||u.isIOS,isWindows:u.isWindows,showEmojiInline:u.isWindows,emojiType:a,highlightDiscussionId:void 0,theme:f,intl:x,renderedPageBlockId:void 0,parentBlockId:void 0,katex:void 0,isClient:!0,baseUrl:be.default.domainBaseUrl,publicDomainName:be.default.publicDomainName,currentUserId:d.currentUser.id,getPublicBaseUrlForPage:void 0,externalIntegrations:[],formulaValueTypes:[],emojiData:g,isMobileNative:u.isMobileNative,isMobileNativeExternalLinkFixEnabled:je.default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:je.default.checkGate({gateName:"display_date_in_user_timezone"})},style:o.style,classNames:o.classNames,index:t,token:i,tokenValue:p.WiV(i),tokenAnnotations:p.hDy(i)}):(0,U.jsx)("span",{className:[e.classNames||"",...o.classNames].join(" "),style:o.style,"data-token-index":e.textTokenIndex,children:e.value},t)}))}),[t.input,l.value,f,n,c,u.isAndroid,u.isSafari,u.isIOS,u.isWindows,u.isMobileNative,a,x,d.currentUser.id,g]),y=(0,r.VK)((()=>Array.isArray(t.output)?(0,ve.IY)({textValue:{value:t.output,spaceId:c},getRecordModel:n,getRecordRole:()=>{},disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,he.r)(),disabled:!1,isAndroid:u.isAndroid,isSafariOrIOS:u.isSafari||u.isIOS,isWindows:u.isWindows,showEmojiInline:u.isWindows,emojiType:a,theme:f,intl:x,katex:void 0,isClient:!0,baseUrl:be.default.domainBaseUrl,publicDomainName:be.default.publicDomainName,currentUserId:d.currentUser.id,getPublicBaseUrlForPage:void 0,externalIntegrations:[],formulaValueTypes:[],emojiData:g,isMobileNative:u.isMobileNative,isMobileNativeExternalLinkFixEnabled:je.default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:je.default.checkGate({gateName:"display_date_in_user_timezone"})}):t.output),[u.isAndroid,u.isIOS,u.isSafari,u.isWindows,u.isMobileNative,g,a,d.currentUser.id,t.output,n,x,c,f]),b=!1!==t.isCopyable&&("string"==typeof t.input||!0===t.isCopyable),S=(0,o.useCallback)((()=>{if(b){const e=(Array.isArray(t.input)?(0,ge.X)({intl:x,textValue:t.input,getRecordModel:n,userTimeZone:(0,he.r)()}):t.input).replaceAll(/\/\*.*\*\//g,"").trim();ye.RD({stringValue:e,environment:d,copiedMessage:Be.copiedExampleMessage})}}),[d,t.input,n,x,b]),I=(0,s.yK)((e=>({code:{fontFamily:"monospace",whiteSpaceCollapse:"preserve",fontSize:11,borderRadius:5,border:`1px solid ${e.stroke.deemphasized}`,margin:"0 -4px",padding:"0 6px",pointerEvents:"none",opacity:.95,display:"flex",flexDirection:"row",alignItems:"center",tabSize:2},left:{flexGrow:1,padding:"6px 0"},right:{alignSelf:"center"},copyButton:{height:22,width:22,pointerEvents:"auto"},copyButtonIcon:{height:12,width:12}})),[]);return(0,U.jsxs)("div",{style:I.code,children:[(0,U.jsxs)("div",{style:I.left,children:[(0,U.jsx)("div",{children:v}),y?(0,U.jsxs)("div",{children:["= ",y]}):null]}),b?(0,U.jsx)("div",{style:I.right,children:(0,U.jsx)(Te.Z,{ariaLabel:x.formatMessage(Be.copyToClipboard),onClick:S,icon:fe.U,style:I.copyButton,iconStyle:I.copyButtonIcon,disallowTabbing:!0})}):null]})}function Ve(e){let{name:t,icon:n,description:o,examples:i,style:r}=e;const l=(0,s.yK)((e=>({helper:{display:"flex",flexDirection:"column",fontSize:12,height:"auto",width:"100%",gap:8,overflow:"auto",textWrap:"wrap",...r},name:{fontSize:14,fontWeight:600,display:"flex",alignItems:"center"},description:{color:e.mediumTextColor},iconStyle:{height:14,width:14,fill:e.mediumIconColor,display:"inline",marginRight:6},divider:{borderColor:e.stroke.deemphasized},examples:{display:"flex",flexDirection:"column",gap:4}})),[r]);return(0,U.jsxs)("div",{style:l.helper,children:[(0,U.jsxs)("span",{style:l.name,children:[void 0!==n&&n(l.iconStyle),t]}),void 0!==o&&(0,U.jsx)("span",{style:l.description,children:o}),void 0!==i&&(0,U.jsx)("div",{style:l.examples,children:i})]})}function Ee(e){let{completion:t,getRecordModel:n,style:o}=e;const{name:i,description:s,icon:l,examples:a}=(0,r.VK)((()=>{if(!n)return{};if(t.token.type===Q.Oy.BlockProperty){var e;if(Q.WG.includes(t.token.property)&&!t.token.collection){var o;const e=null===(o=Q.dy[t.token.property])||void 0===o?void 0:o.type,i=e?q.wG[e]:void 0,r=Y.QP[t.token.property],s="function"==typeof(null==r?void 0:r.description)?r.description():null==r?void 0:r.description,l=t.name??t.token.property;return{name:l,icon:i,description:s?oe.default.formatMessage(s):void 0,examples:null!==r?Re(r,n,{collection:t.token.collection,property:t.token.property,name:l},{name:l,type:t.token.property}):void 0}}if(!t.token.collection)return{};const i=(0,d.SR)(t.token.property),r=n(t.token.collection),s=null==r||null===(e=r.getNormalizedSchema())||void 0===e?void 0:e[i];if(!s)return{};const l=Y.QP[s.type];return l?{name:t.name,icon:q.wG[s.type],description:oe.default.formatMessage("function"==typeof l.description?l.description(s):l.description),examples:Re(l,n,{collection:t.token.collection,property:i,name:t.name},s)}:{}}return{}}),[t,n]);return void 0===i?null:(0,U.jsx)(Ve,{name:i,icon:l,description:s,examples:a,style:o})}function Re(e,t,n,o){const i=e.examples;let r=[];return r="function"==typeof i?i(n,o).map(((e,n)=>(0,U.jsx)(Ae,{example:e,getRecordModel:t},n))):i.map(((e,n)=>(0,U.jsx)(Ae,{example:e,getRecordModel:t},n))),r.length>0?r:void 0}function Pe(e){return Ce.Gs(e)?[e.data]:Ce.kK(e)?[e.textContent||"",e.className]:void 0}const Be=(0,m.defineMessages)({codeExamples:{id:"formula2Input.helperText.codeExamples",defaultMessage:"Examples"},copiedExampleMessage:{id:"formula2Input.helperText.copiedExampleMessage",defaultMessage:"Copied example to clipboard!"},copyToClipboard:{defaultMessage:"Copy to Clipboard",id:"database.copyButton.copyToClipboard"}}),Ne=(0,m.defineMessages)({currentValueDescription:{id:"formula2Input.helperText.currentValueDescription",defaultMessage:"Returns the value of the current item in the list function."},currentIndexDescription:{id:"formula2Input.helperText.currentIndexDescription",defaultMessage:"Returns the index of the current item in the list function, starting from 0."},variableType:{id:"formula2Input.variableHelper.description",defaultMessage:"User-defined variable."},listVariableType:{id:"formula2Input.variableHelper.descriptionWithList",defaultMessage:"User-defined variable, list."},emailForUser:{id:"formula2Input.helperText.emailForUser",defaultMessage:"Returns the email address of a provided user."},nameForUser:{id:"formula2Input.helperText.nameForUser",defaultMessage:"Returns the display name of a provided user."}});var De=n(721396);function Oe(e){const{store:t,selection:n,cursorEditorInfo:l,cursorEditorInfoRef:a,context:u,onChange:c,getRecordModel:m,setInfoHelper:f}=e,g=(0,s.yK)((()=>({menu:{top:0,left:0,right:0,bottom:0,position:"absolute",marginBottom:2},menuSection:{paddingTop:6,paddingBottom:2}})),[]),v=(0,i.Fy)(),y=(0,r.qz)(void 0,re.Z),b=(0,o.useMemo)((()=>{const e=h.vM((null==l?void 0:l.completions)??[],"kind");let o=-1;return Object.entries(e).map(((e,i)=>{const[r,s]=e,l=s.map(((e,r)=>{o+=1;const s=o;return{key:`${i}-${r}`,render:t=>(0,U.jsx)(Ze,{...t,completion:e,context:u,getRecordModel:m,menuListStore:y,indexGlobal:s,cursorEditorInfoRef:a,setInfoHelper:f}),action:()=>{var o;void 0!==e&&a.current&&(f({...e,calledFromUnifiedFunctionProperty:"member dot receiver"===(null===(o=a.current.completionsInfo)||void 0===o?void 0:o.type)}),function(e){var t;const{completion:n,store:o,selection:i,onChange:r,cursorEditorInfo:s}=e,l=(null==i?void 0:i.startIndex)||0,a=(null==i?void 0:i.endIndex)||0,u=l!==a,c=(null===(t=s.completionsInfo)||void 0===t?void 0:t.prefix)||"",m="overridePrefixLength"in n?n.overridePrefixLength??0:c.length,h=u?l:a-m,f=o.getValue();if(n.kind===Q.x2.Token){if(n.token.type===Q.Oy.Checkbox)return;if(n.token.type===Q.Oy.BlockProperty){const e=(0,p._QS)(f,h,a),t=n.token.collection?(0,d.SR)(n.token.property):n.token.property,o=(0,p.YCD)((0,p.kbv)({collection:n.token.collection,property:t,name:n.name}));return void r({newValue:(0,p.P$X)(e,[o],h),newSelection:{startIndex:h+1,endIndex:h+1}})}if(n.token.type===Q.Oy.ContextValue){const e=(0,p._QS)(f,h,a),t=(0,d.Kv)(n.token.valueId),o=(0,p.YCD)((0,p._QF)({id:t}));r({newValue:(0,p.P$X)(e,[o],h),newSelection:{startIndex:h+1,endIndex:h+1}})}else{if(n.token.type===Q.Oy.Date||n.token.type===Q.Oy.Block||n.token.type===Q.Oy.Person)return;(0,x.t1)(n.token)}}else if(n.kind===Q.x2.LibraryFunction){var g,v,y,b;const e=(0,p._QS)(f,h,a),t=(0,p.V3y)(`${n.libraryFunction.name}()`,[]),o=(0,p.P$X)(e,[t],h);let i=h+n.libraryFunction.name.length+1;void 0!==(null===(g=n.libraryFunction)||void 0===g||null===(g=g.parameters)||void 0===g?void 0:g.varargs)||null!==(v=n.libraryFunction)&&void 0!==v&&null!==(v=v.parameters)&&void 0!==v&&null!==(v=v.expected)&&void 0!==v&&v.length&&(1!==(null===(y=n.libraryFunction)||void 0===y||null===(y=y.parameters)||void 0===y||null===(y=y.expected)||void 0===y?void 0:y.length)||"member dot receiver"!==(null===(b=s.completionsInfo)||void 0===b?void 0:b.type))||(i+=1);r({newValue:o,newSelection:{startIndex:i,endIndex:i}})}else if(n.kind===Q.x2.Binding||n.kind===Q.x2.Builtin){const e=(0,p._QS)(f,h,a),t=n.kind===Q.x2.Binding?n.text:`${n.builtin} `,o=(0,p.V3y)(t,[]),i=(0,p.P$X)(e,[o],h),s=h+t.length;r({newValue:i,newSelection:{startIndex:s,endIndex:s}})}else(0,x.t1)(n)}({completion:e,store:t,selection:n,onChange:c,cursorEditorInfo:a.current}))}}}));return{key:r,render:e=>(0,U.jsx)(me.Z,{...e,style:g.menuSection,title:oe.default.formatMessage(We[r])}),items:l}}))}),[u,null==l?void 0:l.completions,a,m,y,c,n,f,t,g.menuSection]),k=(0,o.useCallback)((e=>{var t;if(v.isMobile)return;const n=void 0!==e.indexGlobal?null===(t=a.current)||void 0===t||null===(t=t.completions)||void 0===t?void 0:t[e.indexGlobal]:void 0;var o;n&&f({...n,calledFromUnifiedFunctionProperty:"member dot receiver"===(null===(o=a.current)||void 0===o||null===(o=o.completionsInfo)||void 0===o?void 0:o.type)})}),[a,v.isMobile,f]);let S;return(0,o.useEffect)((()=>{if(v.isMobile)return;const e=e=>{var t,n;if(void 0!==e.state.focus.indexGlobal&&null!==(t=a.current)&&void 0!==t&&t.completions&&(null===(n=a.current)||void 0===n?void 0:n.completions.length)>0){var o;const t=null===(o=a.current)||void 0===o||null===(o=o.completions)||void 0===o?void 0:o[e.state.focus.indexGlobal];void 0!==t&&f((e=>{var n;return void 0===e||void 0===(null===(n=a.current)||void 0===n?void 0:n.callParameter)?t:e}))}};return y.addListener(e),()=>y.removeListener(e)}),[a,y,f,v.isMobile]),(0,o.useEffect)((()=>{var e,t,n,o;if(v.isMobile)return;const i="function"===(null==l||null===(e=l.callParameter)||void 0===e||null===(e=e.expression)||void 0===e||null===(e=e.type)||void 0===e?void 0:e.type)?null===(t=l.callParameter.expression)||void 0===t?void 0:t.type:void 0;void 0!==i&&void 0!==(null==l||null===(n=l.callParameter)||void 0===n?void 0:n.parameterIndex)&&(null==l||null===(o=l.callParameter)||void 0===o?void 0:o.parameterIndex)>-1&&f({kind:Q.x2.LibraryFunction,libraryFunction:i.libraryFunction,calledFromUnifiedFunctionProperty:i.calledFromUnifiedFunctionProperty})}),[null==l?void 0:l.callParameter,v.isMobile,f]),(0,o.useEffect)((()=>{b.length>0&&y.update((e=>({focus:{...e,section:0,indexLocal:0,indexGlobal:0}})))}),[b.length,y,f]),S=v.isPhone?{menuType:ie.og.ActionSheet,disableBottomPadding:!0,maxHeight:"100%"}:{menuType:ie.og.Popup,width:v.isPhone?180:228,minWidth:v.isPhone?180:228,maxWidth:v.isPhone?180:228},(0,U.jsx)(de.Z,{...S,scrollerStyle:g.menu,children:(0,U.jsx)(ce.Z,{type:ce.i.Vertical,initialFocus:0,priority:1,store:y,onKeyboardArrow:k,sections:h.oA([...b,0===b.length&&{key:"no-results",render:e=>(0,U.jsx)(me.Z,{...e,disableDesktopPadding:!0,style:g.menuSection,children:(0,U.jsx)(Le,{})}),items:[]}])})})}const Ze=o.forwardRef((function(e,t){const{completion:n,context:l,getRecordModel:a,menuListStore:u,indexGlobal:c,cursorEditorInfoRef:p,setInfoHelper:h,onMouseEnter:f,...g}=e,v=(0,i.Fy)(),y=(0,s.yK)((e=>({icon:{width:14,fill:e.mediumIconColor},lightParens:{color:e.lightTextColor}})),[]),b=(0,o.useCallback)((e=>{if(!v.isMobile){var t;const e=null===(t=p.current)||void 0===t||null===(t=t.completions)||void 0===t?void 0:t[c];h(e)}null==f||f(e)}),[p,c,f,h,v.isMobile]),k=(0,r.VK)((()=>u.state.focus.indexGlobal===c),[u,c]),S=(0,o.useMemo)((()=>v.isMobile?(0,U.jsx)(ae.ZP,{popupType:ae.Z4.SlideUp,renderOrigin:e=>(0,U.jsx)(N.Z,{mobileFeedback:!0,style:{width:16,height:16},...e,children:(0,ne.S)(y.icon)}),render:e=>{var t;let o;return o=v.isMobile?{menuType:ie.og.Modal,title:(0,U.jsx)(m.FormattedMessage,{defaultMessage:"Documentation",id:"database.formulaPropertyEntryMenuItem.title"}),right:(0,U.jsx)(pe.DoneMenuText,{}),onClickRight:e.close}:{menuType:ie.og.Popup},(0,U.jsx)(de.Z,{...o,children:(0,U.jsx)(me.Z,{children:(0,U.jsx)(ue.Z,{title:(0,U.jsx)(Fe,{infoHelper:{...n,calledFromUnifiedFunctionProperty:"member dot receiver"===(null==p||null===(t=p.current)||void 0===t||null===(t=t.completionsInfo)||void 0===t?void 0:t.type)},getRecordModel:a,style:{padding:4}}),style:{paddingTop:16,paddingBottom:16}})})})}}):(0,U.jsx)(Ue,{visible:k})),[n,p,v.isMobile,a,k,y.icon]),I=(0,r.VK)((()=>{var e;if(n.kind!==Q.x2.Token||n.token.type!==Q.Oy.BlockProperty||!a)return;if(Q.WG.includes(n.token.property))return n.token.property;if(!n.token.collection)return;const t=(0,d.SR)(n.token.property),o=a(n.token.collection);return null==o||null===(e=o.getNormalizedSchema())||void 0===e||null===(e=e[t])||void 0===e?void 0:e.type}),[n,a]);if(n.kind===Q.x2.Token){if(n.token.type===Q.Oy.Checkbox)return null;if(n.token.type===Q.Oy.BlockProperty)return(0,U.jsx)(le.Z,{...g,icon:I?q.wG[I](y.icon):(0,U.jsx)(Ge,{type:"unknown"}),title:n.name??n.token.property,right:S,onMouseEnter:b,ref:t});if(n.token.type===Q.Oy.ContextValue){const e=(0,d.vx)(l.valueTypes,(0,d.Kv)(n.token.valueId));return e?(0,U.jsx)(le.Z,{...g,icon:(0,U.jsx)(Ge,{type:e.type.type}),title:(0,U.jsx)("div",{style:{display:"flex"},children:(0,U.jsx)(De.Fg,{value:e,format:$.lo.Medium,isSingle:!0,shouldShrink:!0})}),right:S,onMouseEnter:b,ref:t}):null}if(n.token.type===Q.Oy.Date)return null;if(n.token.type===Q.Oy.Block)return null;if(n.token.type===Q.Oy.Person)return null;(0,x.t1)(n.token)}else{if(n.kind===Q.x2.LibraryFunction){const e=n.libraryFunction.returnType;return(0,U.jsx)(le.Z,{...g,icon:(0,U.jsx)(Ge,{type:"function"==typeof e?e([]).type:e.type}),title:(0,U.jsxs)(U.Fragment,{children:[n.libraryFunction.name,(0,U.jsx)("span",{style:y.lightParens,children:"()"})]}),right:S,onMouseEnter:b,ref:t})}if(n.kind===Q.x2.Builtin)return(0,U.jsx)(le.Z,{...g,title:n.builtin,icon:(0,U.jsx)(Ge,{type:ee[n.builtin].type.type}),right:S,onMouseEnter:b,ref:t});if(n.kind===Q.x2.Binding)return(0,U.jsx)(le.Z,{...g,title:n.text,icon:(0,U.jsx)(Ge,{type:n.type.type}),right:S,onMouseEnter:b,ref:t});(0,x.t1)(n)}})),Ue=o.memo((function(e){let{visible:t}=e;const n=(0,s.yK)((e=>({icon:{width:14,fill:e.mediumIconColor,transition:"opacity 50ms 200ms",visibility:t?"visible":"hidden",opacity:t?1:0}})),[t]);return(0,te.U)(n.icon)})),Ge=o.memo((function(e){var t;let{type:n}=e;const o=(0,s.yK)((e=>({icon:{width:14,fill:e.mediumIconColor,transition:"transform .3s ease"}})),[]);return null===(t=_e(n))||void 0===t?void 0:t(o.icon)}));function _e(e){return"text"===e?q.wG.text:"number"===e?q.wG.number:"checkbox"===e?q.wG.checkbox:"date"===e?q.wG.date:"block"===e?q.wG.relation:"person"===e?q.wG.person:"select"===e?q.wG.select:"array"===e?q.wG.multi_select:"function"===e||void 0===e||"unknown"===e?q.wG.formula:void(0,x.t1)(e)}function Le(){return(0,U.jsx)(se.Z,{caption:(0,U.jsx)(m.FormattedMessage,{defaultMessage:"No results",id:"FormulaAutocompleteMenu.noResults.message"})})}const Ke=(0,m.defineMessages)({[Q.x2.Token]:{defaultMessage:"Properties",id:"formulaAutocompleteMenu.token.message"},[Q.x2.LibraryFunction]:{defaultMessage:"Functions",id:"formulaAutocompleteMenu.function.message"},[Q.x2.Binding]:{defaultMessage:"Variables",id:"formulaAutocompleteMenu.variables.message"},[Q.x2.Builtin]:{defaultMessage:"Built-ins",id:"formulaAutocompleteMenu.builtin.message"}}),We={[Q.x2.Token]:Ke[Q.x2.Token],[Q.x2.LibraryFunction]:Ke[Q.x2.LibraryFunction],[Q.x2.Binding]:Ke[Q.x2.Binding],[Q.x2.Builtin]:Ke[Q.x2.Builtin]};var He=n(37652),ze=n(584169),Xe=n(662134),qe=n(918514),$e=n(825464),Qe=n(489728),Ye=n(158297),Je=n(526388);const et={height:24,padding:"0 8px"},tt=(0,m.defineMessages)({accept:{defaultMessage:"Accept",id:"database.formula.acceptFormulaInput.tooltip"},back:{defaultMessage:"Back",id:"formulas.SimpleFormulaValuePicker.back"},close:{id:"formula2Input.close",defaultMessage:"Close"},done:{id:"formula2Input.done",defaultMessage:"Done"},formulaHeader:{id:"formula2Input.NotionFormula",defaultMessage:"Notion Formula"},learnTooltip:{id:"formula2Input.learnAboutFormulas",defaultMessage:"Learn about formulas!"},revert:{id:"formula2Input.revert",defaultMessage:"Revert"},revertTooltip:{id:"formula2Input.revertTooltip",defaultMessage:"Revert to previous formula"}}),nt=o.memo((function(e){const{onClickAssistant:t,onClickBack:n,onClickClose:o,onClickRevert:i,showRevert:r,disabled:l}=e,a=(0,s.yK)((e=>({headerRow:{color:e.mediumTextColor,flexWrap:"wrap",fontWeight:500,fontSize:14}})),[]);return(0,U.jsxs)(B.jX,{direction:"row",padding:"10px 12px 0 12px",style:a.headerRow,children:[(0,U.jsx)(B.jX,{width:"fill",children:n?(0,U.jsx)(it,{onClick:n}):(0,U.jsx)(lt,{})}),(0,U.jsxs)(B.jX,{width:"hug",direction:"row",gap:6,align:"center",children:[r?(0,U.jsx)(at,{onClick:i}):null,(0,U.jsx)(I.D,{experimentId:"formula_assistant",groups:{on:(0,U.jsx)(ot,{onClick:t})}}),l?(0,U.jsx)(rt,{onClick:o}):(0,U.jsx)(st,{onClick:o})]})]})}));function ot(e){const{onClick:t}=e;return(0,U.jsx)(Je.Z,{placement:$e.u.Top,render:e=>(0,U.jsx)(Qe.Z,{...e,"aria-label":"Ask AI",isSmall:!0,icon:E.t,onClick:t,children:"Ask AI"}),renderTooltip:()=>"Ask AI"})}function it(e){const{onClick:t}=e,n=(0,m.useIntl)();return(0,U.jsx)(Qe.Z,{isGray:!0,isSmall:!0,icon:He.V,onClick:t,children:n.formatMessage(tt.back)})}function rt(e){const{onClick:t}=e,n=(0,m.useIntl)();return(0,U.jsx)(Ye.Z,{onClick:t,style:et,children:n.formatMessage(tt.close)})}function st(e){const{onClick:t}=e,n=(0,i.O7)(),o=(0,m.useIntl)(),r=(0,s.yK)((e=>({commandText:{color:e.mediumInvertedTextColor}})),[]);return(0,U.jsx)(Je.Z,{renderTooltip:()=>(0,U.jsxs)("div",{children:[(0,U.jsx)("span",{children:o.formatMessage(tt.accept)})," ",(0,U.jsxs)("span",{style:r.commandText,children:[Xe.fg(n).command,"+Enter"]})]}),render:e=>(0,U.jsx)(Ye.Z,{onClick:t,style:et,...e,children:o.formatMessage(tt.done)})})}function lt(){const e=(0,m.useIntl)(),t=(0,s.yK)((()=>({headerTitle:{fontSize:12,display:"flex",alignItems:"center"},helpButton:{marginLeft:2,height:20,width:20}})),[]);return(0,U.jsxs)("span",{style:t.headerTitle,children:[e.formatMessage(tt.formulaHeader),(0,U.jsx)(Je.Z,{placement:$e.u.Top,render:n=>(0,U.jsx)(Te.Z,{...n,ariaLabel:e.formatMessage(tt.learnTooltip),icon:ze.m,href:(0,qe.UY)("guides.formulas"),external:!0,style:t.helpButton}),renderTooltip:()=>e.formatMessage(tt.learnTooltip)})]})}function at(e){const{onClick:t}=e,n=(0,m.useIntl)(),o=(0,s.yK)((e=>({revertButton:{color:e.mediumIconColor}})),[]);return(0,U.jsx)(Je.Z,{placement:$e.u.Top,render:e=>(0,U.jsx)(Qe.Z,{...e,"aria-label":n.formatMessage(tt.revertTooltip),isGray:!0,isSmall:!0,style:o.revertButton,onClick:t,children:n.formatMessage(tt.revert)}),renderTooltip:()=>n.formatMessage(tt.revertTooltip)})}n(252262),n(324506);var dt=n(883355),ut=n(701302),ct=n(313991),pt=n(14577),mt=n(415095),ht=n(662193),ft=n(606746),xt=n(452423),gt=n(56971),vt=n(214976),yt=n(245023),bt=n(489086),kt=n(70853),St=n(530874),It=n(129595),Ct=n(693262);const Mt={flexGrow:1,flexShrink:1,textAlign:"left",fontFamily:g.Z.getCompositeFontFamily(ct.SP).githubMono,fontSize:12,tabSize:2,whiteSpace:"pre-wrap",borderRadius:4,minHeight:"1em",height:"100%",wordBreak:"break-all",paddingLeft:12,paddingRight:13,paddingBottom:10,paddingTop:11};class wt extends dt.Z{constructor(){super(...arguments),this.editor=null,this.mergeEditorRefs=(0,ht.sH)(),this.renderContentContainer=(e,t)=>{let{leafRef:n,wrapperRef:i,...r}=e;const{device:s}=this.environment,l=this.textValueStore.state.length>0;return(0,U.jsxs)("div",{ref:i,...r,onKeyDown:e=>{!function(e,t,n){(0,yt.Z)(n,e,"command+enter")&&(t(),e.stopPropagation())}(e,this.props.handleSave,this.environment),null==r||r.onKeyDown(e)},style:{flexGrow:1,display:"table",position:"relative"},children:[(0,U.jsx)(Tt,{hasText:l}),(0,U.jsx)(It.Z,{ref:this.mergeEditorRefs(this.editorRef,n),style:Mt,getDisabled:()=>this.props.disabled,getHtml:()=>function(e,t,n,i,r,s,l,a,d,u,c,m,f){const x=p.QaF(e),g="notion",v=n.languages[g],y=document.createElement("div"),b=n.highlight(x,v,g);y.innerHTML=Me.g7(b);const k=h.oA(Array.from(y.childNodes).map(At));for(const o of t)e=p.aSf({textValue:e,selection:o,annotation:[p.GKr.FormulaError]});const S=function(e){let{syntaxTokens:t,textValue:n,store:o,parentSpaceId:i,valueTypes:r,theme:s,isAndroid:l,isSafariOrIOS:a,isWindows:d,isMobileNative:u,currentUserId:c,getPublicBaseUrlForPage:m}=e;const h=Me.kF(n,t),f=n.map(p.hDy).map(((e,t)=>ve.fn({annotations:e,theme:s,getRecordModel:o.getRecordModel,spaceId:i})));return h.map(((e,t)=>{const h=n[e.textTokenIndex],x=f[e.textTokenIndex];return p.km_(h)?(0,ve.$i)({args:{textValue:{value:n,spaceId:i},getRecordModel:o.getRecordModel,getRecordRole:o.getRecordRole,disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,he.r)(),disabled:!1,isAndroid:l,isSafariOrIOS:a,isWindows:d,showEmojiInline:d,emojiType:"raw",highlightDiscussionId:void 0,theme:s,intl:oe.default.getIntl(),renderedPageBlockId:void 0,parentBlockId:void 0,katex:void 0,isClient:!0,baseUrl:be.default.domainBaseUrl,publicDomainName:be.default.publicDomainName,currentUserId:c,getPublicBaseUrlForPage:m,externalIntegrations:St.Z.integrations.state,formulaValueTypes:r,emojiData:Ie.Z.state,isMobileNative:u,isMobileNativeExternalLinkFixEnabled:je.default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:je.default.checkGate({gateName:"display_date_in_user_timezone"})},style:x.style,classNames:x.classNames,index:t,token:h,tokenValue:p.WiV(h),tokenAnnotations:p.hDy(h)}):(0,U.jsx)("span",{className:[e.classNames||"",...x.classNames].join(" "),style:x.style,"data-token-index":e.textTokenIndex,children:e.value},t)}))}({store:i,parentSpaceId:r,valueTypes:s,syntaxTokens:h.oA(k),textValue:e||[],theme:l,isAndroid:a,isSafariOrIOS:d,isWindows:u,isMobileNative:c,getPublicBaseUrlForPage:m,currentUserId:f}),I=(0,U.jsxs)(o.Fragment,{children:[S,(0,U.jsx)("span",{children:"\n"})]});return ft.Z.renderToStaticMarkup(I)}(this.textValueStore.state,this.props.errorRanges,this.props.Prism,this.props.store,this.props.parentSpaceId,this.props.valueTypes,this.theme,s.isAndroid,s.isSafari||s.isIOS,s.isWindows,s.isMobileNative,kt.aR(this.environment),this.environment.currentUser.id),getSelection:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_getContainerSelection,onMutation:e=>function(e,t,n){const{newValue:o}=e;V.createAndCommit({userAction:"FormulaInputText.handleMutation",environment:n,perform:e=>{A.aS({environment:n,editorMode:"default",store:t,newValue:o,disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,disableFilters:!0,transaction:e}),e.postEnqueueActions.push((()=>{V.createAndCommit({userAction:"FormulaInputText.normalizeTextValue",environment:n,perform:e=>{A.vE({store:t,transaction:e})}})}))}})}(e,this.props.store,this.environment),spellCheck:!1,autoCorrect:"off",autoCapitalize:"off",onSelect:t,onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut,onFocus:this.props.onFocus,suppressNewlineEvents:!1,expandSelectionOnTripleClick:!0,placeholder:" "})]})},this.handleClick=e=>{vt.SD({environment:this.environment,event:e,textValue:this.textValueStore.state,editorNode:this.getEditorNode(),store:this.props.store,canEdit:!this.props.disabled})},this.handleDelete=e=>{if(this.props.disabled)return;const t=S.default.state;"editing"===t.mode&&t.multiSelection.start.store===this.props.store&&(V.createAndCommit({userAction:"FormulaInputText.handleDelete",environment:this.environment,perform:n=>{gt.as({environment:this.environment,multiSelection:t.multiSelection,deleteForwards:!0,transaction:n,event:e,editorMode:"default"})}}),this.scrollSelectionIntoView())},this.handleBackspace=e=>{if(this.props.disabled)return;const t=S.default.state;if("editing"===t.mode&&t.multiSelection.start.store===this.props.store){if(gt.YV({device:this.environment.device,event:e,multiSelection:t.multiSelection}))return;V.createAndCommit({userAction:"FormulaInputText.handleBackspace",environment:this.environment,perform:n=>{gt.as({environment:this.environment,multiSelection:t.multiSelection,deleteForwards:!1,transaction:n,event:e,editorMode:"default"})}}),this.scrollSelectionIntoView()}},this.handleShiftEnter=e=>{var t,n,o;if(this.props.disabled)return;if(null===(t=e.preventDefault)||void 0===t||t.call(e),this.editor&&this.editor.isComposing())return;const i=S.default.state,r="editing"===i.mode&&(0,b.QY)(i.multiSelection);if(!r)return;const s=this.textValueStore.state,l=mt.p4(p.QaF(s)),a=null===(n=l.slice(0,r.selection.startIndex).join("").split("\n"))||void 0===n?void 0:n.at(-1),d=(null==a||null===(o=a.match(/^\t*/))||void 0===o?void 0:o[0].length)||0,u=(null==a?void 0:a.split("").reverse())||[];let c=0;const m=u.some((e=>{if(")"===e)c++;else if("("===e){if(0===c)return!0;c--}return!1}))?d+1:d;let h="\t".repeat(m);const f=")"===l[r.selection.endIndex],x=!(null==a||!a.endsWith("("))&&f;x&&(h+=`\n${"\t".repeat(m-1)}`),V.createAndCommit({userAction:"FormulaInputText.handleShiftEnter",environment:this.environment,perform:e=>{A.hJ({environment:this.environment,editorMode:"default",store:this.props.store,string:`\n${h}`,selection:r.selection,disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,transaction:e}),x&&v.Z5({store:this.props.store,selection:{startIndex:r.selection.startIndex+m+1,endIndex:r.selection.startIndex+m+1}})}}),this.scrollSelectionIntoView()},this.handleCopy=e=>{var t;const{markdownLinkifyIt:n}=this.props,o=window.getSelection();null!=o&&o.anchorNode&&null!==(t=this.editor)&&void 0!==t&&null!==(t=t.getNode())&&void 0!==t&&t.contains(o.anchorNode)&&ye.JG({environment:this.environment,event:e,markdownLinkifyIt:n})},this.handleCut=e=>{const{markdownLinkifyIt:t}=this.props;this.props.disabled?e.preventDefault():(ye.by({environment:this.environment,event:e,markdownLinkifyIt:t}),this.scrollSelectionIntoView())},this.handlePaste=e=>{const{markdownLinkifyIt:t,tinyMceMicrosoftWordPasteFilter:n}=this.props;this.props.disabled?e.preventDefault():(V.createAndCommit({userAction:"FormulaInputText.handlePaste",environment:this.environment,perform:o=>{ye.v({environment:this.environment,event:e,disableEmbedMenu:!0,transaction:o,onPasteFiles:ye.AL,markdownLinkifyIt:t,tinyMceMicrosoftWordPasteFilter:n})}}),this.scrollSelectionIntoView())},this.handleMouseOver=e=>{vt.vO({environment:this.environment,event:e,textValue:this.textValueStore.state,editorNode:this.getEditorNode(),store:this.props.store,canEdit:!this.props.disabled})},this.handleMouseOut=e=>{vt.kV({environment:this.environment,event:e,textValue:this.textValueStore.state,editorNode:this.getEditorNode(),store:this.props.store,canEdit:!this.props.disabled})},this.scrollSelectionIntoView=()=>{const e=window.getSelection();null!=e&&e.rangeCount&&ut.default.afterNextFlush((()=>{var t;const n=e.getRangeAt(0).getClientRects()[0],o=null===(t=this.editor)||void 0===t||null===(t=t.getNode())||void 0===t||null===(t=t.parentElement)||void 0===t?void 0:t.parentElement,i=null==o?void 0:o.getBoundingClientRect();n&&o&&i&&(i.top>=n.top?o.scrollTo({top:o.scrollTop+(n.top-i.top)-6}):i.bottom<=n.bottom+n.height&&o.scrollTo({top:o.scrollTop+(n.bottom-i.bottom)+28}))}))},this.clearBrowserSelection=()=>{var e;null===(e=this.getEditorNode())||void 0===e||e.blur()},this.textValueStore=new pt.Z((()=>this.props.store.getValue()||[]),{debugName:"FormulaInputText.textValueStore"}),this.isEditingStore=this.createComputedStore((()=>{var e;const t=S.default.state;return"editing"===t.mode&&(null===(e=(0,b.QY)(t.multiSelection))||void 0===e?void 0:e.store)===this.props.store})),this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_getContainerSelection=()=>function(e,t){if(t.state)return(0,bt.HE)(e)}(this.props.store,this.isEditingStore),this.getEndSelection=()=>{const e=mt.p4(p.QaF(this.textValueStore.state));return{startIndex:e.length,endIndex:e.length}},this.editorRef=e=>{this.editor=e}}UNSAFE_willMount(e){e.focus&&v.NX({store:e.store})}renderComponent(){const{store:e,disabled:t,handleSave:n}=this.props;return(0,U.jsx)(D.Z,{debugName:"FormulaInputText",capture:!0,allowEnter:!0,allowTabUntab:!0,allowUndo:!0,allowEsc:!0,allowCopyPaste:!0,children:(0,U.jsx)(Ct.Z,{store:e,disabled:t,clearBrowserSelection:this.clearBrowserSelection,getEndSelection:this.getEndSelection,onClick:this.handleClick,onDelete:this.handleDelete,onBackspace:this.handleBackspace,onShiftEnter:this.handleShiftEnter,onCommandShiftEnter:h.yR,onTab:e=>function(e,t,n,o){if(t)return;e.preventDefault();const i=S.default.state,r="editing"===i.mode&&(0,b.QY)(i.multiSelection);r&&V.createAndCommit({userAction:"FormulaInputText.handleTab",environment:o,perform:e=>{A.wA({environment:o,store:n,editorMode:"default",selection:r.selection,transaction:e,shouldStripTokens:!1,disableFilters:!0})}})}(e,this.props.disabled,this.props.store,this.environment),onUntab:e=>function(e,t,n,o){if(t)return;e.preventDefault();const i=S.default.state,r="editing"===i.mode&&(0,b.QY)(i.multiSelection);r&&V.createAndCommit({userAction:"FormulaInputText.handleUntab",environment:o,perform:e=>{A.O5({environment:o,store:n,editorMode:"default",selection:r.selection,transaction:e,shouldStripTokens:!1,disableFilters:!0})}})}(e,this.props.disabled,this.props.store,this.environment),onToggleBold:e=>Vt(e,this.props.disabled),onToggleItalics:e=>Vt(e,this.props.disabled),onToggleUnderline:e=>Vt(e,this.props.disabled),onToggleStrike:e=>Vt(e,this.props.disabled),onToggleCode:h.yR,onCopy:this.handleCopy,onCut:this.handleCut,onPaste:this.handlePaste,onMoveUp:e=>{return t=this.environment,void V.createAndCommit({userAction:"FormulaInputText.handleMoveUp",environment:t,perform:e=>{A.fs({environment:t,transaction:e,direction:"up"})}});var t},onMoveDown:e=>{return t=this.environment,void V.createAndCommit({userAction:"FormulaInputText.handleMoveDown",environment:t,perform:e=>{A.fs({environment:t,transaction:e,direction:"down"})}});var t},onUndo:e=>function(e,t,n){var o;e.preventDefault();const i=xt.XT();(null==i||null===(o=i.getFirstStore())||void 0===o?void 0:o.id)===t.id&&xt.Yw(n)}(e,this.props.store,this.environment),onRedo:e=>function(e,t,n){var o;e.preventDefault();const i=xt.M7();(null==i||null===(o=i.getFirstStore())||void 0===o?void 0:o.id)===t.id&&xt.KX(n)}(e,this.props.store,this.environment),onEsc:n,render:this.renderContentContainer,disableStyleAnnotations:!0,disableMentions:!0,disableSlashCommands:!0,canSelectAllBlocks:!1,canInsertText:!0,canSelectionDrag:!0,disableMobileActionBar:!0,topBottomPadding:40,pasteBehavior:"inline"})})}getEditorNode(){var e;return(null===(e=this.editor)||void 0===e?void 0:e.getNode())||void 0}}wt.displayName="FormulaInputText";const jt=(0,m.defineMessages)({formulaPlaceholder:{id:"formulas.formulaPlaceholder",defaultMessage:"Your formula"}});function Tt(e){const{hasText:t}=e,n=(0,m.useIntl)();return(0,U.jsx)(B.jX,{direction:"row",gap:8,padding:"10px 12px",style:{position:"absolute",inset:0,pointerEvents:"none",userSelect:"none"},children:t?null:(0,U.jsx)(B.jX,{height:20,align:"center-left",children:(0,U.jsx)(Z.q,{colorName:"quaternary",styleName:"Body-14px/Regular",children:n.formatMessage(jt.formulaPlaceholder)})})})}function Ft(e){const{value:t}=(0,we.XJ)(ke.FF.prismjs),{value:n}=(0,we.XJ)(ke.FF.markdownLinkifyIt),{value:o}=(0,we.XJ)(ke.FF.tinyMceMicrosoftWordPasteFilter);return t?(0,U.jsx)(wt,{...e,Prism:t,markdownLinkifyIt:n,tinyMceMicrosoftWordPasteFilter:o}):null}function At(e){return Ce.Gs(e)?[e.data]:Ce.kK(e)?[e.textContent||"",e.className]:void 0}function Vt(e,t){t||e.preventDefault()}const Et=!1,Rt=400;function Pt(e){const{evaluationErrors:t,initialCode:n,parentSpaceId:c,outputFooter:g,disabled:E,typecheckContext:R,formulas:P,handleBack:B,onCodeChange:N,onTypeChange:D,parentCollectionStore:O}=e,Z=(0,m.useIntl)(),_=(0,i.Fy)(),L=(0,i.O7)(),{store:K,setValue:W}=(0,y.Cl)({initialValue:n,onChange:N,source:"formula",parentCollectionStore:O}),H=(0,o.useCallback)((e=>{if(W(e.newValue),e.newSelection){const t={start:{store:K,index:e.newSelection.startIndex},end:{store:K,index:e.newSelection.endIndex}};v.NA({multiSelection:t})}}),[W,K]),z=(0,r.VK)((()=>{var e;const t=S.default.state;if("editing"===t.mode&&(null===(e=(0,b.QY)(t.multiSelection))||void 0===e?void 0:e.store)===K)return{startIndex:t.multiSelection.start.index,endIndex:t.multiSelection.end.index}}),[K]),q=(0,r.VK)((()=>!h.Xy(K.getValue(),n)),[n,K]),{handleClose:$}=e,Q=(0,o.useCallback)((()=>{$(K.getValue())}),[$,K]),Y=(0,r.VK)((()=>K.getValue()),[K]),[J,ee]=(0,r.VK)((()=>Y?P.processFormulaInput(Y):[void 0,void 0]),[Y,P]),te=(0,r.VK)((()=>{if(J)return P.parseFormulaInputToCst(J,ee)}),[J,P,ee]),ne=(0,r.VK)((()=>{if(te)return P.convertFormulaCSTToAST(te[0])}),[P,te]),[oe,ie]=(0,o.useState)(void 0);(0,o.useEffect)((()=>{!async function(){if(ne&&R&&f.x.isSuccess(ne)){const e=await P.addTypesToFormulaASTAsync(ne.value,R,ee);ie(e),null==D||D(e.node.type)}else ie(void 0)}()}),[ne,R,ee,te,P,D]);const re=(0,o.useMemo)((()=>void 0!==oe?[...(0,d.Kl)(oe.node,!1),...oe.errors]:[]),[oe]),se=(0,o.useMemo)((()=>({parseErrors:(null==te?void 0:te[1])??[],typeErrors:re,evaluationErrors:t})),[t,te,re]),le=(0,u.Kt)(se,Rt,Object.is),ae=se.parseErrors.length+se.typeErrors.length+se.evaluationErrors.length>0,de=(0,r.VK)((()=>function(e){const{errors:t,intl:n,codeLength:o,formulas:i}=e,{parseErrors:r,typeErrors:s,evaluationErrors:a}=t,d=[];if(s&&s.length>0){const e=s.map((e=>{const t=(0,l.FR)((0,l.ic)(e));return{msg:n.formatMessage(...t),range:{startIndex:e.node.startOffset,endIndex:e.node.endOffset+1}}}));d.push(...e)}else if(a&&a.length>0){const e=a.map((e=>{const t=(0,l.FR)((0,l.OY)(e));return{msg:n.formatMessage(...t),range:i.isUniqueFormulaEvaluatorError(e)?{startIndex:e.node.startOffset,endIndex:e.node.endOffset+1}:void 0}}));d.push(...e)}if(r){const e=r.map((e=>{const t=(0,l.FR)((0,l.sG)(e));return{msg:n.formatMessage(...t),range:"eof"===e.offset?{startIndex:o-1,endIndex:o}:{startIndex:e.offset,endIndex:e.offset+1}}}));d.push(...e)}return d}({errors:le,codeLength:ee?(0,a.eD)(ee):(0,p.QaF)(Y).length,formulas:P,intl:Z})),[Y,le,P,Z,ee]),ue=(0,o.useMemo)((()=>de.map((e=>e.range)).filter(x.$K)),[de]),[ce,pe]=(0,o.useState)(void 0),me=(0,o.useRef)(void 0),[he,fe]=(0,o.useState)(void 0),xe=(0,o.useRef)(1);(0,o.useEffect)((()=>{xe.current++;const e=xe.current;!async function(){if(P){const t=await P.getFormulaEditorInfoAtPosition({formula:Y??[],inputPosition:z&&z.startIndex===z.endIndex?z.startIndex:0,context:R,includeDeprecatedCompletions:!1});f.x.isSuccess(t)&&xe.current===e&&(me.current=t.value,pe(t.value))}}()}),[z,P,R,Y]);const ge=(0,o.useCallback)((()=>{W(n)}),[n,W]),ve=(0,r.qz)(void 0,X),ye=(0,o.useCallback)((()=>{ve.toggleAssistantVisible()}),[ve]),be=(0,o.useCallback)((()=>{ve.hideAssistant()}),[ve]),ke=(0,r.VK)((()=>ve.state.isAssistantVisible),[ve]),Se=(0,r.VK)((()=>{var e;return null==O||null===(e=O.getSchemaStore)||void 0===e||null===(e=e.call(O))||void 0===e?void 0:e.getValue()}),[O]),Ie=(0,o.useCallback)((async()=>{var e;const t=null===(e=k.default.state.currentSpaceStore)||void 0===e?void 0:e.id,n=ve.state.prompt;if(!t||!n)return;ve.didBeginRequest();const o=function(e){const{prompt:t,collectionSchema:n,typecheckContext:o}=e,i=[];if(n){const{sourceProperty:e}=o;for(const[t,o]of Object.entries(n))t!==e&&void 0!==o&&i.push({name:o.name,type:o.type,example:void 0})}return{type:"formula",prompt:t,properties:i}}({prompt:n,collectionSchema:Se,typecheckContext:R}),i=await async function(e){const{environment:t,spaceId:n,formulaInferenceContext:o}=e,i=M.Il();await T.publishAiSession(t,{inference_type:"formula",spaceId:n,id:i,metadata:{from:"formulaAssistant"}});const r=await T.getCompletion(t,{id:(0,j.ZP)(),context:o,model:"openai-2",spaceId:n,isSpacePermission:!1,aiSessionId:i,metadata:{}});if("success"!==r.type)return void F.showError(r);let s="";if(w.H1.is(r.data))for await(const l of r.data)"success"===l.type&&(s+=l.completion);return s}({environment:L,spaceId:t,formulaInferenceContext:o});i&&function(e){const{environment:t,store:n,newValue:o}=e;V.createAndCommit({userAction:"FormulaInputText.handleMutation",environment:t,perform:e=>{A.YV({environment:t,store:n,newValue:o,editorMode:"default",disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,disableFilters:!0,transaction:e}),e.postEnqueueActions.push((()=>{V.createAndCommit({userAction:"FormulaInputText.normalizeTextValue",environment:t,perform:e=>{A.vE({store:n,transaction:e})}})}))}})}({environment:L,store:K,newValue:i}),ve.didFinishRequest()}),[L,Se,ve,K,R]),Ce=(0,o.useCallback)((()=>{}),[]);Et&&console.log("FormulaInput",{currentValue:Y,cursorEditorInfo:ce,infoHelper:he,errorMessagesWithRange:de,errorRanges:ue,astWithTypes:oe});const Me=(0,s.yK)((e=>({container:{display:"flex",height:"100%",paddingBottom:void 0,flexDirection:"column"},editorSection:{display:"flex",flexDirection:"column",backgroundColor:"light"===e.mode?e.cardBackground:e.accentColors.gray[30]},inputText:{display:"flex",flexGrow:1,flexShrink:1,overflow:"auto",maxHeight:"min(calc(90vh - 240px - 38px - 30px), 298px)",minHeight:"40px",cursor:"text"},bottomSection:{display:"flex",flexDirection:"row",height:_.isMobile?"100%":240,maxHeight:_.isMobile?void 0:"calc(90vh - 38px - 31px - 38px - 30px)",borderTop:`1px solid ${e.outlineButtonBorder}`},leftColumn:{position:"relative",borderRight:`1px solid ${e.outlineButtonBorder}`,width:_.isMobile?"100%":void 0},rightColumn:{display:"flex",flexDirection:"column",flexGrow:1},infoHelper:{padding:"12px 14px"}})),[_.isMobile]);return(0,U.jsx)(C.Z,{debugName:"FormulaInput",capture:!0,children:(0,U.jsxs)("div",{style:Me.container,children:[(0,U.jsxs)("div",{style:Me.editorSection,children:[(0,U.jsx)(nt,{onClickBack:B,onClickClose:Q,onClickRevert:ge,onClickAssistant:ye,showRevert:q,disabled:E}),(0,U.jsx)("div",{style:Me.inputText,children:(0,U.jsx)(Ft,{value:Y,focus:!0,store:K,disabled:E,parentSpaceId:c,valueTypes:R.valueTypes,errorRanges:ue,handleSave:Q,onFocus:be},"input")})]}),de.length>0&&ae?(0,U.jsx)(Bt,{errorMessagesWithRange:de}):g,ke?(0,U.jsx)(I.D,{experimentId:"formula_assistant",groups:{on:(0,U.jsx)(G,{formulaAssistantStore:ve,onStop:Ce,onSubmit:Ie})}}):null,!E&&!ke&&(0,U.jsxs)("div",{style:Me.bottomSection,children:[(0,U.jsx)("div",{style:Me.leftColumn,children:(0,U.jsx)(Oe,{store:K,context:R,selection:z,cursorEditorInfo:ce,cursorEditorInfoRef:me,onChange:H,getRecordModel:e.getRecordModel,setInfoHelper:fe})}),!_.isMobile&&(0,U.jsx)("div",{style:Me.rightColumn,children:(0,U.jsx)(Fe,{infoHelper:he,getRecordModel:e.getRecordModel,style:Me.infoHelper})})]})]})})}const Bt=o.memo((function(e){let{errorMessagesWithRange:t}=e;const n=(0,s.yK)((e=>({errors:{display:"flex",flexDirection:"row",alignItems:"center",padding:10,fontSize:g.Z.fontSize.UISmall.desktop,height:38,width:"100%",borderTop:`1px solid ${e.outlineButtonBorder}`,textWrap:"nowrap",color:e.darkTextColor,flexShrink:0},icon:{width:12,height:12,fill:"light"===e.mode?e.accentColors.red[400]:e.accentColors.red[700],display:"inline",marginRight:4,marginTop:1},errorMessages:{overflow:"hidden",textOverflow:"ellipsis",color:"light"===e.mode?e.accentColors.red[500]:e.accentColors.red[800]}})),[]);return 0===t.length?null:(0,U.jsxs)("div",{style:n.errors,children:[(0,c.t)(n.icon),(0,U.jsx)("span",{style:n.errorMessages,children:t.slice(0,3).map(((e,t)=>(0,U.jsx)(Nt,{index:t,errorMessageWithRange:e},t)))})]})}));function Nt(e){let{errorMessageWithRange:t,index:n}=e;const{msg:o,range:i}=t,r=(0,s.yK)((()=>({errorRange:{opacity:.75}})),[]);return(0,U.jsxs)(U.Fragment,{children:[n>0?" ":null,o,void 0!==i&&(0,U.jsxs)(U.Fragment,{children:[" ",(0,U.jsx)("span",{style:r.errorRange,children:`[${i.startIndex},${i.endIndex}]`})]})]})}},196711:(e,t,n)=>{n.d(t,{V:()=>r});n(667294);var o=n(745238),i=n(785893);const r=(0,o.IU)("checkboxSquareChecked",{viewBox:"0 0 14 14",svg:(0,i.jsx)("path",{d:"M2.85742 13.4561H11.1357C12.6123 13.4561 13.3779 12.6904 13.3779 11.2344V2.91504C13.3779 1.45215 12.6123 0.693359 11.1357 0.693359H2.85742C1.38086 0.693359 0.615234 1.45215 0.615234 2.91504V11.2344C0.615234 12.6973 1.38086 13.4561 2.85742 13.4561ZM2.93945 12.1162C2.30371 12.1162 1.95508 11.7812 1.95508 11.1182V3.02441C1.95508 2.36133 2.30371 2.0332 2.93945 2.0332H11.0537C11.6826 2.0332 12.0381 2.36133 12.0381 3.02441V11.1182C12.0381 11.7812 11.6826 12.1162 11.0537 12.1162H2.93945ZM6.26855 10.3115C6.51465 10.3115 6.72656 10.1885 6.87012 9.96973L9.92578 5.19141C10.0146 5.04785 10.0967 4.88379 10.0967 4.72656C10.0967 4.3916 9.7959 4.16602 9.47461 4.16602C9.26953 4.16602 9.08496 4.27539 8.94141 4.50781L6.24121 8.8418L4.96973 7.22168C4.80566 7.00977 4.6416 6.93457 4.43652 6.93457C4.10156 6.93457 3.8418 7.20117 3.8418 7.54297C3.8418 7.70703 3.90332 7.85742 4.01953 8.00098L5.63281 9.96973C5.81738 10.209 6.01562 10.3115 6.26855 10.3115Z"})})},664878:(e,t,n)=>{n.d(t,{h:()=>r});n(667294);var o=n(745238),i=n(785893);const r=(0,o.IU)("dot",{viewBox:"0 0 5 4",svg:(0,i.jsx)("circle",{cx:"2.5",cy:"2",r:"2"})})},780926:(e,t,n)=>{n.d(t,{z:()=>r});n(667294);var o=n(745238),i=n(785893);const r=(0,o.IU)("flag",{viewBox:"0 0 13 14",svg:(0,i.jsx)("path",{d:"M0.825195 13.8457C1.16699 13.8457 1.4541 13.5654 1.4541 13.2168V9.47754C1.63867 9.40918 2.21973 9.19727 3.10156 9.19727C5.59668 9.19727 7.25781 10.4414 9.66406 10.4414C10.7168 10.4414 11.1885 10.3115 11.7217 10.0654C12.207 9.84668 12.4941 9.4502 12.4941 8.82129V1.99219C12.4941 1.55469 12.1523 1.27441 11.6943 1.27441C11.3047 1.27441 10.6895 1.54102 9.58887 1.54102C7.20996 1.54102 5.52148 0.296875 3.0332 0.296875C1.99414 0.296875 1.5293 0.419922 0.975586 0.672852C0.49707 0.891602 0.196289 1.24707 0.196289 1.86914V13.2168C0.196289 13.5586 0.483398 13.8457 0.825195 13.8457ZM9.63672 9.16309C7.41504 9.16309 5.71289 7.92578 3.12207 7.92578C2.45215 7.92578 1.84375 8.00098 1.48145 8.14453V2.0332C1.59766 1.83496 2.11035 1.56836 3.05371 1.56836C5.38477 1.56836 7.09375 2.80566 9.56836 2.80566C10.2383 2.80566 10.792 2.73047 11.2158 2.61426V8.69824C11.0996 8.89648 10.5801 9.16309 9.63672 9.16309Z"})})}}]);