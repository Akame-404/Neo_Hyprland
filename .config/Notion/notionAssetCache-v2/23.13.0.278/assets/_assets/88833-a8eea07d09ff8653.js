"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[88833],{436821:(e,t,o)=>{o.d(t,{KV:()=>K,Rh:()=>L,U6:()=>$,Wu:()=>ee,Xx:()=>j,YD:()=>Z,g9:()=>X,jc:()=>G,m8:()=>Y,ys:()=>J,zX:()=>Q});var r=o(730120),n=o(815145),i=o(371663),a=o(102647),c=o(399036),l=o(640506),s=o(253877),p=o(471924),d=o(798963),u=o(718844),m=o(421202),f=o(606287),S=o(815047),v=o(429369),_=o(139927),g=o(894438),y=o(76233),b=o(416732),w=o(940663),C=o(793174),k=o(493911),h=o(710274),V=o(296994),B=o(730459),P=o(741195),I=o(433929),T=o(80444),A=o(206258),U=o(108406),R=o(454642),F=o(316956),M=o(805149),x=o(496802),D=o(709953),E=o(321862),W=o(210228),O=o(239865),z=o(237181);const N="week";function j(e){var t;const{environment:o,transaction:r,tasksBlockStore:n,sprintsBlockStore:i}=e,a=null===(t=i.getFormat())||void 0===t?void 0:t.collection_pointer,c=n.getFormat().collection_pointer;a&&c&&q({environment:o,transaction:r,sprintCollectionStore:A.NW.createChildStore(i,a),taskCollectionStore:A.NW.createChildStore(n,c),sprintSettingsConfig:_.iZ})}function q(e){const{environment:t,sprintSettingsConfig:o,transaction:r,sprintCollectionStore:n,taskCollectionStore:i}=e,a=n.getSpaceId(),c=(0,P.TS)({environment:t,table:d.cv,spaceId:a}),l=(0,P.TS)({environment:t,table:u.Xj,spaceId:a});D.ae({environment:t,table:d.cv,inMemoryRecordCache:n.inMemoryRecordCache,value:{id:c,parent_id:n.id,parent_table:n.table,alive:!0,space_id:a,status:o.autoCompleteSprints?"active":"disabled",trigger:{id:p.Il(),type:"recurrence",recurrence:oe(o)},action_ids:[l]},transaction:r}),x.FH({stores:[n],update:{automation_ids:[...n.getFormat().automation_ids??[],c]},transaction:r}),D.ae({environment:t,table:u.Xj,inMemoryRecordCache:n.inMemoryRecordCache,transaction:r,value:{id:l,parent_id:c,parent_table:d.cv,type:"complete_sprint",alive:!0,space_id:a,config:{sprint_collection:n.getSpaceShardedPointer(),task_collection:i.getSpaceShardedPointer(),complete_sprint_action:o.actionConfig.complete_sprint_action}}})}function K(e){const{environment:t,automationStore:o,transaction:r,newDuration:n,currentSprintBlockStore:i}=e;D.sW({store:o.getTriggerStore().getKeyStore("recurrence"),data:{interval:n},transaction:r}),H({environment:t,transaction:r,automationStore:o,currentSprintBlockStore:i})}function X(e){const{environment:t,automationStore:o,transaction:r,newWeekday:n,currentSprintBlockStore:i}=e;D.sW({store:o.getTriggerStore().getKeyStore("recurrence"),data:{weekdays:[n]},transaction:r}),H({environment:t,transaction:r,automationStore:o,currentSprintBlockStore:i})}function G(e){const{environment:t,automationStore:o,transaction:r,newAutocompleteStatus:n,currentSprintBlockStore:i}=e;D.sW({store:o,data:{status:n?"active":"disabled"},transaction:r}),H({environment:t,transaction:r,automationStore:o,currentSprintBlockStore:i});const c=o.getParentPointer();if(!c||c.table!==f.vF)return;const l=(0,B.mc)(t),s={automation_id:o.id,automation_actions:[{type:"complete_sprint"}],automation_triggers:[{type:"recurrence"}],collection_id:c.id};n?(0,a.Rt)(l,s):(0,a.ai)(l,s)}function H(e){const{automationStore:t,currentSprintBlockStore:o,transaction:n,environment:a}=e;if(!t.isActive())return;const c=t.getRecurrence();if(!c)return;const s=(0,g.Su)(c);if(!s)return;const p=o.getPropertyValue(i.b0.Dates);if(!p)return;const d=(0,y.nai)(p)[0];if(!d||"daterange"!==d.type)return;const u=d.start_date,{start_date:m,end_date:f}=(0,g.DW)({currentSprintStartDate:u,sprintSchedule:s});D.sW({store:t.getTriggerStore().getKeyStore("recurrence"),data:{start_date:(0,l.Io)(r.ou.fromISO(m).plus({minutes:1}).toJSDate())},transaction:n}),k.xD({store:o,propertyId:i.b0.Dates,transaction:n,environment:a,type:"dateValue",dateValue:{type:"daterange",start_date:u,end_date:f}})}function $(e){const{transaction:t,newRemainingTasksBehavior:o,actionStore:r}=e;D.sW({store:r.getConfigStore(),data:{complete_sprint_action:o},transaction:t})}async function J(e){var t;const{appTemplatesSetupActions:o,appTemplatesSprintBoardActions:r,appConfigs:a}=await V.FF.AppTemplates.load(),{environment:c,collectionContextStore:l,from:s}=e,{currentSpaceViewStore:p}=T.default.state,d=l.collectionStore(),u=null==d?void 0:d.getParentBlockStore(),f=null==u?void 0:u.getParentStore(),_=null==d||null===(t=d.getFormat())||void 0===t?void 0:t.app_config_uri,g=_&&(0,w.YB)(a(),_);if(!d||!u||!f||!p||f.table!==S.bx&&f.table!==m.iU&&f.table!==v.e0||!g)return;const y=u.getFormat().app_id,C=y?await R.getCollectionViewBlocksByAppId(c,{spaceId:u.getSpaceId(),appId:y}):void 0,k="success"===(null==C?void 0:C.type)&&C.data.result.length?C.data.result.map((e=>A.G.createChildStore(f,{table:m.iU,id:e.blockId,spaceId:u.getSpaceId()}))):[u];await te({environment:c,taskCollectionStore:d,executeFn:()=>{W.createAndCommit({userAction:"sprintSettingsActions.handleTurnOnSprints",environment:c,perform:e=>{const t=(0,b.eu)(),a=o.applyTypedFeatures({environment:c,spaceViewStore:p,appParentStore:f,appUri:g.uri,features:[{type:"simple",featureUri:t.uri}],transaction:e,createOrModify:"modify",appCollectionViewBlockStores:k}),d=r.createSprintPage({environment:c,spaceViewStore:p,appParentStore:f,transaction:e,blockStores:a,creationEntryPoint:{type:"sprint_settings"}});if(M.E3({collectionSettingsStore:l.settingsStore}),!d)return;E.r({environment:c,store:d,pageVisitSource:n.tY.Create});const u=s?{feature:{id:i.Es.TaskToSprintRelation,from:s,type:"notion://projects/tasks_with_sprints_feature"}}:{};U._H({environment:c,collectionContextStore:l,from:"view_settings",property:i.Es.TaskToSprintRelation,property_type:"relation",is_suggested_property:!0,...u})}})}})}async function Y(e){const{environment:t,collectionContextStore:o,sprintSettingsContext:r,sprintBoardViewBlockIds:a}=e,{sprintCollectionStore:c,automationContext:l,currentCollectionViewBlockStore:s,sprintCollectionViewBlockStore:p,taskCollectionStore:d,taskCollectionViewBlockStore:u}=r;if(!c||!p||!l)return;const f=u.getSpaceId(),S=[p,...a.map((e=>new A.G(t,{id:e,table:m.iU,spaceId:f})))];s.id===u.id?M.E3({collectionSettingsStore:o.settingsStore}):E.r({environment:t,store:u,pageVisitSource:n.tY.LeaveOrRemove});const{automationActions:v}=await C._1.load(),{automationStore:_}=l;await te({environment:t,taskCollectionStore:d,executeFn:()=>{W.createAndCommit({userAction:"sprintSettingsActions.handleTurnOffSprints",environment:t,perform:e=>{!function(e){const{transaction:t,blocksToDelete:o,environment:r,taskCollectionStore:n,sprintCollectionStore:a}=e;D.sW({store:a,transaction:t,data:{alive:!1}}),F.E2({environment:r,collectionStore:n,schema:n.getSchema(),property:i.Es.TaskToSprintRelation,transaction:t,permanentlyDelete:!0}),O.y8({environment:r,blocks:o,transaction:t,permanentlyDelete:!0})}({environment:t,transaction:e,blocksToDelete:S,sprintCollectionStore:c,taskCollectionStore:d}),v.disableAutomation({automationStore:_,environment:t,transaction:e}),v.deleteAutomation({automationStore:_,environment:t,transaction:e})}}),U.y9({environment:t,collectionContextStore:o,property_type:"relation",from:"view_settings",property:i.Es.TaskToSprintRelation})}})}function Q(e){const{environment:t,userSettingsStore:o}=e;W.createAndCommit({userAction:"sprintSettingsActions.handleSeenSprintsEngagementBanner",environment:t,perform:e=>{z.d2({userSettingsStore:o,data:{seen_sprint_settings_engagement_banner:!0},transaction:e})}})}function L(e){e.settingsStore.setState({open:!0,stack:[{type:"main"},{type:"sprintSettings"}]})}function Z(e){const{environment:t,collectionContextStore:o,currentViewBlockStore:r,taskCollectionViewBlockStore:n}=e,a=o.collectionViewStore();if(!a)return;const c=a.getFormat(),l=a.getRawQuery();W.createAndCommit({userAction:"sprintSettingsActions.handleManageSprintFromThisView",environment:t,perform:e=>{if(h.iG({collectionViewStore:a,transaction:e,update:{name:I.default.formatMessage(b.sY.tasksCurrentSprintV2ViewName),query2:{...l,filter:void 0},format:{...c,collection_view_icon:"/icons/playback-play-button_gray.svg",property_filters:b.Jt,app_config_uri:i.g3,hide_linked_collection_name:!0}}}),r.id===n.id){var t;const o=(null===(t=r.getFormat())||void 0===t?void 0:t.app_uri_map)??{},l=c.app_config_uri;l&&delete o[l],x.FH({stores:[n],update:{app_uri_map:{...o,[i.g3]:a.id}},transaction:e})}}})}function ee(e){const{environment:t,sprintSettingsContext:o}=e;if(!o)return;const r=o.sprintCollectionStore;r&&!o.automationContext&&W.createAndCommit({userAction:"sprintSettingsActions.ensureCompleteSprintAutomation",environment:t,perform:e=>{q({environment:t,transaction:e,sprintCollectionStore:r,taskCollectionStore:o.taskCollectionStore,sprintSettingsConfig:_.iZ})}})}async function te(e){const{executeFn:t,environment:o,taskCollectionStore:r}=e;await async function(e){var t;const{environment:o,taskCollectionStore:r}=e,n=r.getFormat().app_uri_map,a=i.Es.TaskToSprintRelation,l=r.getSchema(),s=(null==n?void 0:n[a])??a,p=l[s];if(!p||!(0,c.p_)(p))return;const d=null===(t=(0,c.j0)(p))||void 0===t?void 0:t.id;if(!d)return;const u=new Set([s]);Object.entries(l).forEach((e=>{var t;let[o,r]=e;r&&(0,c.p_)(r)&&(null===(t=(0,c.j0)(r))||void 0===t?void 0:t.id)===d&&u.add(o)}));const{serverCommitResult:m}=W.createAndCommit({userAction:"sprintSettingsActions.clearSprintRelationDataFromTaskCollection",environment:o,perform:e=>{for(const t of u)F.E2({environment:o,transaction:e,permanentlyDelete:!0,collectionStore:r,schema:l,property:t});null==n||delete n[a],n&&x.FH({stores:[r],transaction:e,update:{app_uri_map:n}})}});await m}({environment:o,taskCollectionStore:r}),t()}function oe(e){return{frequency:N,interval:e.recurrenceConfig.interval,weekdays:e.recurrenceConfig.weekdays,start_date:r.ou.local().set({hour:0,minute:0,second:0,millisecond:0}).toMillis(),timezone:(0,s.Sv)(),hour:0,minute:0}}},948083:(e,t,o)=>{o.d(t,{JR:()=>N,K$:()=>O,MR:()=>q,P8:()=>W,jo:()=>j,k0:()=>E,tn:()=>X});o(757658),o(21703);var r=o(371663),n=o(114714),i=o(399036),a=o(180951),c=o(977657),l=o(406695),s=o(335102),p=o(474181),d=o(421202),u=o(606287),m=o(213493),f=o(509844),S=o(815047),v=o(429369),_=o(519889),g=o(76233),y=o(653965),b=o(401898),w=o(928673),C=o(496802),k=o(594419),h=o(119785),V=o(709953),B=o(328014),P=o(400150),I=o(710274),T=o(110906),A=o(521100),U=o(27105),R=o(623879),F=o(277181),M=o(530874),x=o(206258),D=o(940663);function E(e){var t,o,i,a,c,s,p,d,u,f,S,v,_,g;const{environment:w,collectionStore:C,collectionViewBlockStore:h,dependency:B,blockUriMap:P,transaction:I}=e,T=P[B.uri];if(T){const e=x.Xr.createChildStore(h,{table:m.np,id:T,spaceId:h.getSpaceId()});return V.sW({store:e,data:{alive:!0,parent_id:h.id,parent_table:h.table},transaction:I}),k.R3({parentStore:h.getCollectionViewsStore(),appendStore:e,transaction:I}),P}const A=C.getPropertyMapping(),U=G(null===(t=B.value.format)||void 0===t?void 0:t.collection_group_by,C),R=G(null===(o=B.value.format)||void 0===o?void 0:o.board_columns_by,C),M=H(null===(i=B.value.format)||void 0===i?void 0:i.board_columns,C),E=null==A?void 0:A[r.Es.SubTaskRelation],W=null==A?void 0:A[r.Es.BlockingRelation],O=B.value.type,z=O?(0,l.oz)(O):void 0,N=z?null===(a=B.value.format)||void 0===a?void 0:a[z]:void 0,j=z?{[z]:H(N,C)}:{},q=H(null===(c=B.value.format)||void 0===c?void 0:c.board_properties,C),K=H(null===(s=B.value.format)||void 0===s?void 0:s.table_properties,C);if(E&&!(0,F.Av)(O)&&z){var X;const e=null===(X=j[z])||void 0===X?void 0:X.findIndex((e=>e.property===E)),t=j[z];t&&(!e||e<0?t.push({property:E,visible:!0}):t[e].visible=!0)}const J={...B.value.format,collection_group_by:U,board_columns_by:R,board_columns:M,board_properties:q,table_properties:K,property_filters:null===(p=B.value.format)||void 0===p||null===(p=p.property_filters)||void 0===p?void 0:p.map((e=>{let{id:t,filter:o}=e;const{filter:r}=o;if("relation_contains"===r.operator){const e=(Array.isArray(r.value)?r.value:[r.value]).map((e=>{const t=e.type;if("relative"===t)return e;if("exact"===t){const t=e.value,o=t&&P[t];return o?{...e,value:o}:e}(0,b.t1)(t)}));return{id:t,filter:$({property:o.property,filter:{operator:r.operator,value:e}},C)}}return{id:t,filter:$(o,C)}})),collection_groups:null===(d=B.value.format)||void 0===d||null===(d=d.collection_groups)||void 0===d?void 0:d.map((e=>"relation"===e.value.type&&e.value.value&&!(0,n.t2)(e.value.value)&&P[e.value.value.id]?{...e,value:{type:"relation",value:{id:P[e.value.value.id],table:"block",spaceId:C.getSpaceId()}}}:e)),...j,table_subitem_toggle_column:"title",...W?{timeline_arrows_by:{property:W}}:{}},Y=y.oA(null===(u=B.value.page_sort)||void 0===u?void 0:u.map((e=>P[e]))),Q=null===(f=B.value.query2)||void 0===f||null===(f=f.aggregations)||void 0===f?void 0:f.map((e=>e.property?{...e,property:(null==A?void 0:A[e.property])??e.property}:e)),L=H(null===(S=B.value.query2)||void 0===S?void 0:S.sort,C),Z=null===(v=B.value.query2)||void 0===v?void 0:v.timeline_by,ee=Z?C.getMappedProperty(Z):void 0,te=null===(_=B.value.query2)||void 0===_?void 0:_.calendar_by,oe=te?C.getMappedProperty(te):void 0,re=null===(g=B.value.query2)||void 0===g?void 0:g.filter,ne=re?(0,D.RN)(re,A):void 0,ie=V.ae({environment:w,table:m.np,inMemoryRecordCache:h.inMemoryRecordCache,value:{...B.value,parent_id:h.id,parent_table:h.table,space_id:h.getSpaceId(),format:{...J,app_config_uri:B.uri,collection_pointer:C.pointer},query2:{...B.value.query2,filter:ne,aggregations:Q,sort:L,timeline_by:ee,calendar_by:oe},page_sort:Y,alive:!0},transaction:I});P[B.uri]=ie.id;const ae=x.Xr.createChildStore(h,ie.pointer);return k.R3({parentStore:h.getCollectionViewsStore(),appendStore:ae,transaction:I}),P}function W(e){var t;const{environment:o,collectionStore:r,dependency:n,allFeatures:a,blockUriMap:l,transaction:p}=e;let d=n.propertySchema;if("relation"===d.type){if(!d.collection_pointer)throw new Error("Invalid relation schema.");const e=l[d.collection_pointer.id];if(!e)throw new Error("Relation target collection not found");const t=r.getDeletedSchema(),a=t[n.uri];if(n.isConnectedRelation&&n.integrationId===c.U9&&a&&(0,i.NK)(a)&&a.collection_pointer){const e=T.D8({deletedSchema:t,property:n.uri});if(!e)throw new Error("Deleted property schema was not found");I.xO({environment:o,collectionStore:r,update:e.updateSchema,transaction:p}),I.$N({collectionStore:r,update:e.updateDeletedSchema,transaction:p}),d={...d,collection_pointer:a.collection_pointer,collection_id:a.collection_pointer.id}}else d={...d,collection_pointer:{id:e,table:u.vF,spaceId:r.getSpaceId()},collection_id:e}}else if("select"===d.type){const e=r.getSchema()[n.uri];if(e&&"select"===e.type){var m;const t=(0,D.JN)([n.uri],a),o=y.xH(y.oA(t.map((e=>{var t;if("property"===e.type&&"select"===e.propertySchema.type)return null===(t=e.propertySchema.options)||void 0===t?void 0:t.map((e=>e.id))})))),r=(null===(m=e.options)||void 0===m?void 0:m.filter((e=>!o.includes(e.id))))||[];d={...d,options:[...d.options||[],...r]}}}else if("auto_increment_id"===d.type){const e=r.getSchema(),t=(0,b.qP)(e).find((e=>{var t;const o=e[0],r=null===(t=e[1])||void 0===t?void 0:t.type;return o&&r&&"auto_increment_id"===r}));if(t){var f;const e=t[0];return C.FH({stores:[r],update:{app_uri_map:{...null===(f=r.getFormat())||void 0===f?void 0:f.app_uri_map,[n.uri]:e}},transaction:p}),n.uri}}else if("text"===d.type)d.ai_inference&&d.ai_inference.auto_update_on_edit&&(d.ai_inference.auto_update_on_edit=(0,R.k4)());else if("rollup"===d.type){if(!d.relation_property||!d.target_property)throw new Error("Invalid rollup schema.");const e=r.getSchema()[d.relation_property];if(!e||"relation"!==e.type||!e.collection_pointer)throw new Error("Invalid rollup schema.");const t=r.getParentStore();if(!t)throw new Error("Undefined parent store.");const o=x.NW.createChildStore(t,e.collection_pointer);if(!o)throw new Error("Relation target collection not found");const n=o.getMappedProperty(d.target_property);n&&(d.target_property=n)}else if("formula"===d.type&&"v2"===d.version&&d.formula2){const e=(0,s.Wo)(d.formula2.code,(e=>{let{requested:t}=e;if(t.id===n.collectionUri)return r.pointer}),r.pointer);d.formula2.code=e}I.xO({environment:o,collectionStore:r,update:{[n.uri]:d},transaction:p}),C.FH({stores:[r],update:{app_uri_map:{...null===(t=r.getFormat())||void 0===t?void 0:t.app_uri_map,[n.uri]:n.uri}},transaction:p})}function O(e,t,o,r,n,c,l){const s=[...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view"===t}))],m=o.table===S.bx?o.id:o.getSpaceId();if(m){for(const r of s)if("collection_view_block"===r.type){const i=n[r.uri];if(i){var v;const r=x.G.createChildStore(o,{table:d.iU,id:i,spaceId:m});null!==(v=X(t,o,r))&&void 0!==v&&null!==(v=v.getValue())&&void 0!==v&&v.includes(r.id)||j(e,t,o,r,l,"append"),V.sW({store:r,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:l})}else{const i=V.j4({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:o.table===d.iU&&"app_container"===o.getFormat().collection_view_sub_type?"collection_view":"collection_view_page",spaceId:m,format:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover},properties:{title:(0,g.TPx)(r.name)},transaction:l,useCrdt:o.table===d.iU?o.useCrdt():(0,U.S9)("app_template")});V.sW({store:i,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:l}),n[r.uri]=i.id;j(e,t,o,x.G.createChildStore(o,i.pointer),l,"append")}}else if("collection"===r.type){const t=q(o,r.collectionViewBlockUri,n);if(!t)throw new Error("SubViewBlockStore not found");const i=t.getCollectionViewSourceCollectionStore();i&&I.A9({collectionViewBlockStore:t,collectionStore:i,transaction:l});const a=n[r.uri];if(a){const e=x.NW.createChildStore(o,{table:u.vF,id:a,spaceId:m});I.zz({collectionViewBlockStore:t,collectionStore:e,transaction:l}),V.sW({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table},transaction:l})}else{const o=V.ae({environment:e,table:u.vF,inMemoryRecordCache:t.inMemoryRecordCache,value:{...r.value,parent_id:t.id,parent_table:t.table,space_id:t.getSpaceId(),format:{app_config_uri:r.uri,app_uri_map:Object.fromEntries(Object.keys(r.value.schema??{}).filter((e=>e.startsWith("notion://"))).map((e=>[e,e]))),...r.value.format},alive:!0},transaction:l});n[r.uri]=o.id;const i=x.NW.createChildStore(t,o.pointer);I.zz({collectionViewBlockStore:t,collectionStore:i,transaction:l})}}else if("sub_external_collection"===r.type){const t=M.Z.getIntegrationsAsRecordMap().getModel({table:f.K2,id:r.integrationId});if(!t||!(0,p.VM)(t))throw new Error("Invalid integration");const a=N(o,r.parentCollectionUri,n);if(!a)throw new Error("Unable to find parent collection store");const c=a.getDeletedSchema()[r.relationUri];if(c&&(0,i.NK)(c)&&c.collection_pointer){n[r.uri]=c.collection_pointer.id;continue}const s=w.c({environment:e,pattern:r.pattern,integration:t,parentCollectionStore:a,transaction:l});n[r.uri]=s.id}else if("property"===r.type)z({environment:e,appConfig:c,appParentStore:o,dependency:r,uriMap:n,transaction:l});else if("collection_view"===r.type){const t="block"===o.table&&o.getFormat().app_config_uri===r.collectionViewBlockUri?o:q(o,r.collectionViewBlockUri,n);if(!t)throw new Error("View's home block not found");const i=N(o,r.collectionUri,n);if(!i)throw new Error("View source collection not found");n=E({environment:e,collectionStore:i,collectionViewBlockStore:t,dependency:r,blockUriMap:n,transaction:l})}else if("database_template"===r.type){const t=N(o,r.collectionUri,n);if(!t)throw new Error("Collection not found");const i=t.getTemplatePagesStore(),a=n[r.uri];if(a){const e=x.G.createChildStore(t,{table:d.iU,id:a,spaceId:t.getSpaceId()});V.sW({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table,is_template:!0},transaction:l}),k.R3({parentStore:i,appendStore:e,transaction:l}),r.isDefault&&C.FH({stores:[t],update:{collection_default_template:{template_page_id:e.id}},transaction:l})}else{const a=V.j4({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:r.blockValue.type,spaceId:t.getSpaceId(),properties:r.blockValue.properties,format:{...r.blockValue.format,app_config_uri:r.uri},transaction:l,useCrdt:(0,U.S9)("app_template")});V.sW({store:a,data:{parent_id:t.id,parent_table:t.table,alive:!0,is_template:!0},transaction:l}),n[r.uri]=a.id,k.R3({parentStore:i,appendStore:a,transaction:l}),r.isDefault&&C.FH({stores:[t],update:{collection_default_template:{template_page_id:a.id}},transaction:l})}}else"block"===r.type?K(e,o,r,n,l):"page_template"===r.type||(0,b.t1)(r);!function(e,t,o,r,n){for(const i of o){const o=q(t,i.uri,r),c=null==o?void 0:o.getParentStore();if(!o||!c||"collection"!==c.table||!i.blockValue.properties)continue;const l={};Object.entries(i.blockValue.properties).forEach((o=>{var n,i;let[s,p]=o;if("relation"===(null===(n=c.getSchema()[s])||void 0===n?void 0:n.type)){const e=(0,a.rq)(p),o=y.oA(e.map((e=>{const o=r[e.id];if(o)return{table:d.iU,id:o,spaceId:t.table===S.bx?t.id:t.getSpaceId()}}))),n=(0,a.ow)(o);l[s]=n}else"person"===(null===(i=c.getSchema()[s])||void 0===i?void 0:i.type)&&e.currentUser.id?l[s]=(0,a.C1)([{table:_.KJ,id:e.currentUser.id}]):l[s]=p})),A.b({environment:e,store:o,properties:l,transaction:n})}}(e,o,r.filter((e=>{let{type:t}=e;return"block"===t})),n,l)}}function z(e){const{environment:t,transaction:o,appParentStore:r,dependency:n,uriMap:i,appConfig:a}=e,c=N(r,n.collectionUri,i);if(!c)throw new Error("Collection not found");W({environment:t,collectionStore:c,dependency:n,blockUriMap:i,allFeatures:a.allFeatures,transaction:o})}function N(e,t,o){return o[t]?x.NW.createChildStore(e,{table:u.vF,id:o[t],spaceId:e.table===S.bx?e.id:e.getSpaceId()}):void 0}function j(e,t,o,r,n,i){if(o.table!==d.iU)if(o.table===S.bx){if((null==t?void 0:t.getSpaceId())!==o.id)return;B.Hj({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:n})}else o.table===v.e0?P.c0({teamStore:o,store:r,transaction:n,location:{type:i}}):(0,b.t1)(o)}function q(e,t,o){return o[t]?x.G.createChildStore(e,{table:d.iU,id:o[t],spaceId:e.table===S.bx?e.id:e.getSpaceId()}):void 0}function K(e,t,o,r,n){let i=q(t,o.uri,r);const a="collection"===o.parentType?N(t,o.parentUri,r):q(t,o.parentUri,r);if(!a)return{blockStore:i,parentStore:void 0};if(i)V.sW({store:i,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:n});else{const c=t.table===S.bx?t.id:t.getSpaceId();if(!c)return;const l=V.j4({environment:e,type:o.blockValue.type,spaceId:c,format:{...o.blockValue.format,app_config_uri:o.uri},properties:o.blockValue.properties,inMemoryRecordCache:t.inMemoryRecordCache,transaction:n,useCrdt:a.table===d.iU?a.useCrdt():(0,U.S9)("app_template")});V.sW({store:l,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:n}),i=x.G.createChildStore(a,l.pointer),r[o.uri]=l.pointer.id}return"block"===a.table?h.jG({parentStore:a,childStore:i,transaction:n}):"collection"===a.table?h.zw({parentStore:a,childStore:i,transaction:n}):(0,b.t1)(a),{blockStore:i,parentStore:a}}function X(e,t,o){if(t.table===v.e0)return t.getTeamPagesStore();if(t.table===S.bx){var r,n;if(null!==(r=e.getPrivatePagesStore().getValue())&&void 0!==r&&r.includes(o.id))return e.getPrivatePagesStore();if(null!==(n=e.getSharedPagesStore().getValue())&&void 0!==n&&n.includes(o.id))return e.getSharedPagesStore()}else{if(t.table===d.iU)return t.getContentStore();(0,b.t1)(t)}}function G(e,t){if(e)return $(e,t)}function H(e,t){if(e)return e.map((e=>$(e,t)))}function $(e,t){const o=t.getMappedProperty(e.property);return o?{...e,property:o}:e}},288833:(e,t,o)=>{o.r(t),o.d(t,{applyPresetFeatures:()=>X,applyTypedFeatures:()=>H,createTypedDBsInTeam:()=>J,createWikiInTeam:()=>Q,initializeApp:()=>q,installAppsInTeam:()=>Y,markTasksDatabaseTemplateIfNeeded:()=>j,removeTypedDependencies:()=>$});o(757658),o(21703);var r=o(815145),n=o(371663),i=o(541432),a=o(990559),c=o(568626),l=o(471924),s=o(213493),p=o(811002),d=o(173314),u=o(76233),m=o(709291),f=o(653965),S=o(552629),v=o(401898),_=o(436610),g=o(981193),y=o(454642),b=o(774882),w=o(316956),C=o(547307),k=o(496802),h=o(594419),V=o(104617),B=o(709953),P=o(275754),I=o(137231),T=o(210228),A=o(710274),U=o(27105),R=o(721214),F=o(433929),M=o(195697),x=o(361673),D=o(206258),E=o(416536),W=o(940663),O=o(948083),z=o(486095);const N=(0,m.defineMessages)({initializeAppTemplateError:{id:"appTemplateActions.initializeAppTemplateError.message",defaultMessage:"Duplicate template failed."}});function j(e){e&&e.some((e=>e.getFormat().app_config_uri===n.NB))&&(R.y.locallyMutatedTasksDatabase=!0)}function q(e){const{environment:t,temporaryContainerBlockStore:o,transaction:n}=e,i=X({...e,initializeStore:o,createOrModify:"create"});return i&&i.length>0&&P._c({environment:t,store:i[0],redirect:!0,pageVisitSource:r.tY.Onboarding}),n.postSubmitCallbacks.push((async e=>{e?C.showErrorMessage(F.default.formatMessage(N.initializeAppTemplateError)):i&&await async function(e){const{environment:t,appCollectionViewBlockStores:o}=e,r=f.oA(o.map((e=>{const t=e.getCollectionViewCollectionStore();if(t){const e=t.getSchema();if((0,a.$z)(e).length>0)return t}})));for(const n of r)await b.K({environment:t,collectionStore:n})}({environment:t,appCollectionViewBlockStores:i})})),i}function K(e){const{appUri:t,environment:o,parentStore:r,presetUri:n,transaction:a}=e,c=(0,E.appConfigs)().find((e=>e.uri===t));if(!r.isDefined()||!c)return;if(0===c.presets.length)throw new Error(`No presets configuration for specified app: ${t}`);const l=c.presets.find((e=>e.uri===n));if(n&&!l)throw new Error("Couldn't find specified preset");const s=l||c.presets[0],p=(0,W.KC)((0,E.appConfigs)(),s),d=c.presets.filter((e=>!(0,W.Mi)(e.uri))),m=function(e){const{environment:t,spaceViewStore:o,appUri:r,parentStore:n,spaceId:a,transaction:c,startingFeatures:l,defaultPreset:s,nonTypedDBPresets:p,foundConfiguration:d}=e;if(!r.startsWith("notion://wiki")&&1===p.length)return H({environment:t,spaceViewStore:o,appParentStore:n,appUri:r,features:l,createOrModify:"create",transaction:c});const m=B.j4({environment:t,type:i.Ti.collectionViewPage,spaceId:a,format:{app_config_uri:r,collection_view_sub_type:"app_container",page_icon:d.logo,app_template_preset:s.uri,app_template_features:l},properties:{title:(0,u.TPx)(r.startsWith("notion://wiki")?d.name:s.shortName)},inMemoryRecordCache:n.inMemoryRecordCache,transaction:c,useCrdt:(0,U.S9)("app_template")});B.sW({store:m,data:{parent_id:n.id,parent_table:n.table,alive:!0},transaction:c});const f=D.G.createChildStore(n,m.pointer);return(0,O.jo)(t,o,n,f,c,"prepend"),[f]}({...e,startingFeatures:p,defaultPreset:s,nonTypedDBPresets:d,foundConfiguration:c});return"notion://docs_app"===t&&null!=m&&m[0].id&&x.uR({checklistItem:"explore_team_template",blockId:m[0].id,environment:o,transaction:a}),m}function X(e){const{environment:t,appUri:o,presetUri:r,transaction:n,createOrModify:i,from:a}=e,l=(0,E.appConfigs)().find((e=>e.uri===o)),s=null==l?void 0:l.presets.find((e=>e.uri===r));if(s)return n.postSubmitCallbacks.push((e=>{g.Y4(t,{preset_uri:G(r),status:Boolean(e)?"fail":"success",from:a}),e&&c.log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"transactionFailed",error:(0,S.Ui)(e),data:{miscDataToConvertToString:{appUri:o,presetUri:r,createOrModify:i,from:a}}})})),H({...e,features:(0,W.KC)((0,E.appConfigs)(),s)});c.log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"presetNotFound",error:{name:`Preset not found for appUri ${o} and presetUri ${r}. From: ${a}`}})}function G(e){return(0,n.SA)(e)?e:"other"}function H(e){const{environment:t,spaceViewStore:o,appParentStore:r,appUri:n,features:a,transaction:c,createOrModify:s}=e,p=(0,E.appConfigs)().find((e=>e.uri===n));if(!p||!r.isDefined())return;let d;if("modify"===s){const t=f.jj(f.oA(e.appCollectionViewBlockStores.map((e=>e.getFormat().app_id))));if(1!==t.length)throw new Error("App collection view block stores must have the same app id");d=t[0]}const m=(0,W.os)({featurePointers:a,appConfig:p});if(0===m.length)return;let S={};if("create"===e.createOrModify&&e.initializeStore){const o=m.filter((e=>"collection_view_block"===e.type)),r=o[0];r&&(B.sW({store:e.initializeStore,data:{type:e.initializeStore.isType(i.Ti.collectionViewPage)||e.initializeStore.isType(i.Ti.collectionView)?e.initializeStore.getType():i.Ti.collectionViewPage},transaction:c}),B.sW({store:e.initializeStore.getFormatStore(),data:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover,collection_view_sub_type:null,app_template_features:null},transaction:c}),I.sO({environment:t,store:e.initializeStore.getBlockTitleStore(),value:(0,u.TPx)(r.name),transaction:c}),S[r.uri]=e.initializeStore.id)}else"modify"===e.createOrModify&&(S=Object.assign({},...f.oA(e.appCollectionViewBlockStores.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map})))));const v={...S};(0,O.K$)(t,o,r,m,v,p,c),m.map((e=>{if("collection_view_block"===e.type){const t=(0,O.MR)(r,e.uri,v);t&&function(e,t,o){const r=e.getCollectionViewStores().map((e=>{const o=e.getFormat().app_config_uri;let r=o?null==t?void 0:t.indexOf(o):null==t?void 0:t.length;return void 0!==r&&-1!==r||(r=null==t?void 0:t.length),{viewStore:e,order:r}})),n=f.MR(r,(e=>e.order)).map((e=>e.viewStore.id));B.sW({store:e,data:{view_ids:n},transaction:o})}(t,e.defaultViewsOrder||[],c)}}));const _=f.oA(f.jj(f.oA(m.map((e=>{if("collection_view_block"===e.type)return e.uri;if("collection"===e.type||"collection_view"===e.type){const t=(0,W.cn)([e.collectionViewBlockUri],p);if(t&&t.length&&"collection_view_block"===t[0].type)return e.collectionViewBlockUri}}))))),g=f.oA(_.map((e=>(0,O.MR)(r,e,v))));if("create"===s&&e.initializeStore){const t=e.initializeStore.getPermissionItemsStore().getValue();t&&g.forEach((e=>{B.sW({store:e,data:{permissions:t},transaction:c})}))}const y="create"===s?f.oA([e.initializeStore]):e.appCollectionViewBlockStores,b=g.filter((e=>void 0===y.find((t=>t.id===e.id))));if(y.length>0&&b.length>0){const e=y[y.length-1],t=(0,O.tn)(o,r,e);t&&b.forEach(((o,r)=>{h.HP({parentStore:t,currentStore:o,afterStore:0===r?e:b[r-1],transaction:c})}))}const w=d||l.Il();return function(e,t,o,r,n){e.forEach((e=>{const i=e.getFormat().app_config_uri;if(i){var a;const c=(0,W.tX)(new Set([i]),t),l={};c.forEach((e=>{o[e.uri]&&(l[e.uri]=o[e.uri])})),l[i]=o[i],k.FH({stores:[e],update:{app_uri_map:{...(null===(a=e.getFormat())||void 0===a?void 0:a.app_uri_map)||{},...l},app_id:r},transaction:n})}}))}(g,m,v,w,c),g}function $(e){const{environment:t,dependencies:o,appCollectionViewBlockStores:r,from:n}=e,i=function(e){return e.filter((t=>{if("collection"===t.type){return Boolean(e.find((e=>"collection_view_block"===e.type&&e.uri===t.collectionViewBlockUri)))}if("property"===t.type||"collection_view"===t.type||"collection_view_block"===t.type||"page_template"===t.type||"block"===t.type||"database_template"===t.type||"sub_external_collection"===t.type)return!0;(0,v.t1)(t)}))}(o),a=Object.assign({},...f.oA(r.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map}))));T.createAndCommit({userAction:"appTemplateActions.removeTypedDependencies",environment:t,perform:e=>{!function(e){const{environment:t,appCollectionViewBlockStores:o,dependenciesToRemove:r,completeUriMap:n,transaction:i}=e,a=[...r.filter((e=>{let{type:t}=e;return"collection_view"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"page_template"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t}))];for(const l of a)if("collection_view_block"===l.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.uri}));e&&i.postSubmitCallbacks.push((o=>{o||y.deleteBlocks(t,{blocks:[{id:e.id,spaceId:e.getSpaceId()}],permanentlyDelete:!0})}))}else if("collection"===l.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionViewBlockUri}));if(e){const t=(0,O.JR)(e,l.uri,n);t&&A.A9({collectionViewBlockStore:e,collectionStore:t,transaction:i})}}else if("property"===l.type){const r=o.find((e=>{var t;return(null===(t=e.getCollectionStore())||void 0===t||null===(t=t.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionUri}))??o[0],a=(0,O.JR)(r,l.collectionUri,n);if(a){let o;var c;if("relation"===l.propertySchema.type&&l.propertySchema.collection_pointer)o=(0,O.JR)(r,null===(c=l.propertySchema.collection_pointer)||void 0===c?void 0:c.id,n);w.E2({environment:t,collectionStore:a,schema:a.getSchema(),property:l.uri,transaction:i,targetCollectionStore:o}),_.y9(t,{property_type:l.propertySchema.type,from:e.from,property:l.uri,collection_id:a.id})}}else if("collection_view"===l.type){const e=n[l.uri];if(!e)throw new Error("Cannot delete view: id not found in map.");const t=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionViewBlockUri}));if(t){const o=D.Xr.createChildStore(t,{table:s.np,id:e,spaceId:t.getSpaceId()});A.dp({collectionViewBlockStore:t,collectionViewStore:o,transaction:i})}}else"page_template"===l.type||"block"===l.type||"database_template"===l.type||"sub_external_collection"===l.type||(0,v.t1)(l)}({environment:t,appCollectionViewBlockStores:r,dependenciesToRemove:i,completeUriMap:a,transaction:e,from:n})}})}function J(e){const{presetUri:t,environment:o,spaceViewStore:r,teamStore:n,from:i}=e,a=Date.now(),{serverCommitResult:c,performResult:l}=T.createAndCommit({userAction:`teamActions.createTypedDBsInTeam.${E.presetUriToHumanReadableName[t]}`,environment:o,perform:e=>{const a=(0,W.iX)((0,E.appConfigs)(),t);if(!a)return;const c=X({environment:o,spaceViewStore:r,appParentStore:n,appUri:a.uri,createOrModify:"create",transaction:e,presetUri:t,from:i});return z.createSprintPage({environment:o,spaceViewStore:r,appParentStore:n,transaction:e,blockStores:c,creationEntryPoint:{type:"preset",presetUri:t}}),c&&g.bR(o,{created_block_stores:c,preset_uri:t,destination_team_id:n.id,from:i}),c}});return c.then((()=>{g.me(o,{from:i,preset_uri:t,time:Date.now()-a})})),l??[]}async function Y(e){const{environment:t,presets:o,spaceStore:r,spaceViewStore:n,teamStore:i}=e,{isAndroid:a,ramSizeInGB:c}=t.device;if(a&&(!c||c<2)){const e=o.slice().reverse().map((e=>{const{serverCommitResult:o,performResult:a}=T.createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithApps",perform:o=>{var a;const c=null===(a=(0,W.iX)((0,E.appConfigs)(),e))||void 0===a?void 0:a.uri;if(!c)return;return K({environment:t,spaceViewStore:n,appUri:c,parentStore:(0,M.bq)()?i:r,spaceId:r.id,transaction:o,presetUri:e})}});return{serverCommitResult:o,performResult:a}}));await Promise.all(e.map((e=>e.serverCommitResult)));return f.oA(f.xH(f.GY(e.map((e=>e.performResult)))))}{const{serverCommitResult:e,performResult:{collectionViewBlockStores:a}}=T.createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithApps",perform:e=>{const a=f.xH(f.oA(o.slice().reverse().map((o=>{var a;const c=null===(a=(0,W.iX)((0,E.appConfigs)(),o))||void 0===a?void 0:a.uri;if(!c)return;return K({environment:t,spaceViewStore:n,appUri:c,parentStore:(0,M.bq)()?i:r,spaceId:r.id,transaction:e,presetUri:o})}))));return a.reverse(),{collectionViewBlockStores:a}}});return await e,a}}async function Q(e){const{environment:t,spaceStore:o,spaceViewStore:r,teamStore:n,appendOrPrepend:i}=e;return await V.rC({environment:t,item:(0,d.G)(p.Yt.teamWiki,F.default.getIntl()),isPrivate:!1,spaceStore:o,spaceViewStore:r,useMinimalTemplates:!0,teamStore:n,type:"inTeam",from:"sidebar_team_section",isOnboarding:!1,appendOrPrepend:i})}},486095:(e,t,o)=>{o.r(t),o.d(t,{createSprintPage:()=>w});var r=o(371663),n=o(541432),i=o(421202),a=o(213493),c=o(815047),l=o(429369),s=o(709291),p=o(401898),d=o(594419),u=o(709953),m=o(328014),f=o(436821),S=o(400150),v=o(710274),_=o(27105),g=o(433929),y=o(206258);const b=(0,s.defineMessages)({sprintBoard_0:{id:"appTemplatesSprintBoardActions.sprintBoard_0",defaultMessage:"Sprint board"}});function w(e){const{environment:t,spaceViewStore:o,appParentStore:s,transaction:w,blockStores:C,creationEntryPoint:k}=e;if("preset"===k.type&&k.presetUri!==r.tt)return;if(!C)return;const h=C.find((e=>e.getFormat().app_config_uri===r.NB)),V=C.find((e=>e.getFormat().app_config_uri===r.J1));if(!h||!V)return;f.Xx({environment:t,transaction:w,sprintsBlockStore:V,tasksBlockStore:h});return function(e){const{environment:t,spaceViewStore:o,appParentStore:s,transaction:f,tasksBlockStore:w,location:C}=e,k=s.table===c.bx?s.id:s.getSpaceId(),h=s.table===c.bx?s:s.getSpaceStore();if(!k||!h)return;const V=function(e){const{environment:t,appParentStore:o,tasksBlockStore:c,transaction:l,spaceId:s}=e,p=function(e){const{environment:t,appParentStore:o,transaction:r,spaceId:a}=e,c=u.j4({environment:t,type:n.Ti.collectionViewPage,spaceId:a,format:{page_icon:"/icons/run_lightgray.svg",special_page_for_pm_launch:"sprint_board"},properties:{title:[[g.default.formatMessage(b.sprintBoard_0)]]},inMemoryRecordCache:o.inMemoryRecordCache,transaction:r,useCrdt:o.table===i.iU?o.useCrdt():(0,_.S9)("app_template")});u.sW({store:c,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:r});const l=y.G.createChildStore(o,c.pointer);return l}({environment:t,appParentStore:o,transaction:l,spaceId:s});return[r.g3,r.sV,r.y$].forEach((e=>{!function(e){var t;const{collectionViewBlock:o,tasksBlockStore:r,viewUri:n,spaceId:i,transaction:c}=e,l=r.getCollectionPointer(),s=null===(t=r.getFormat())||void 0===t||null===(t=t.app_uri_map)||void 0===t?void 0:t[n];if(!s)return;const p=y.Xr.createChildStore(o,{table:a.np,id:s,spaceId:i});l&&p&&function(e){const{viewStore:t,transaction:o,tasksCollectionPointer:r,viewBlockStore:n}=e,i=t.getName(),a=t.getPageSort(),c=t.getFormat(),l=t.getKeyStore("query2").getValue(),s=t.clone(),p=t.getType();u.sW({store:s,data:{name:i,type:p,page_sort:a,format:{...c,collection_pointer:r},query2:l,alive:!0,parent_id:n.id,parent_table:n.table},transaction:o}),d.R3({parentStore:n.getCollectionViewsStore(),appendStore:s,transaction:o})}({viewStore:p,transaction:c,tasksCollectionPointer:l,viewBlockStore:o});v.dp({collectionViewBlockStore:r,collectionViewStore:p,transaction:c})}({collectionViewBlock:p,tasksBlockStore:c,viewUri:e,spaceId:s,transaction:l})})),p}({environment:t,appParentStore:s,tasksBlockStore:w,transaction:f,spaceId:k});return function(e,t,o,r,n,a){if(o.table===i.iU)"prepend"===a.type&&d.Ce({parentStore:o.getContentStore(),prependStore:r,before:a.before,transaction:n});else if(o.table===c.bx){if(t.getSpaceId()!==o.id)return;m.Hj({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:n,location:a})}else o.table===l.e0?S.c0({teamStore:o,store:r,transaction:n,location:a}):(0,p.t1)(o)}(t,o,s,V,f,C),V}({environment:t,spaceViewStore:o,appParentStore:s,transaction:w,tasksBlockStore:h,location:{type:"prepend",before:V.id}})}},493911:(e,t,o)=>{o.d(t,{Fv:()=>P,JN:()=>C,QG:()=>T,cQ:()=>B,f$:()=>k,fX:()=>V,td:()=>h,xD:()=>I});o(757658);var r=o(730120),n=o(180951),i=o(640506),a=o(253877),c=o(842875),l=o(606287),s=o(653965),p=o(401898),d=o(108406),u=o(554569),m=o(575134),f=o(119785),S=o(709953),v=o(137231),_=o(110906),g=o(95802),y=o(415723),b=o(206258),w=o(866);function C(e){const{environment:t,droppedStores:o,duplicate:s,calendarBy:p,transaction:m,collectionContextStore:S}=e,v=r.ou.fromMillis(e.startOfDay);let g=!0;for(const r of o){const t=e.collectionStore?e.collectionStore:(0,_.Bm)({store:r,collectionContextStore:S});if(r.getParentTable()===l.vF||!t){g=!1;break}f.zw({childStore:r,parentStore:t,transaction:m})||(g=!1)}const y=u.Ab({environment:t,droppedStores:o,duplicate:s,duplicateUseCrdt:"same_as_store",transaction:m,collectionStore:e.collectionStore});for(const r of y){const o=e.collectionStore?e.collectionStore:(0,_.Bm)({store:r,collectionContextStore:S});if(!o)continue;const l=o.getMappedProperty(p),s=r.getPropertyStore(l),f=n.Gl(s.getValue())||a.Lg((0,c.r)()),y=a.c$(f,(0,c.r)()),b=v.toFormat(a.Iq);let w;if("date"===y.type||"datetime"===y.type)w={...y,start_date:b};else{const e=a.NK(y,(0,c.r)());if(!e.end)return;const t={...y,start_date:b},o=a.NK(t,(0,c.r)()).start.diff(e.start,"days"),r=e.end.plus(o).toFormat(a.Iq);w={...y,start_date:b,end_date:r}}const C=a.c$(w,i.yw(f)||(0,c.r)());u.mp({environment:t,store:r,collectionStore:o,collectionContextStore:S,shouldCoerce:!0,groupsPointer:[],transaction:m,alreadyMovedToCollection:g}),I({environment:t,type:"dateValue",propertyId:l,store:r,transaction:m,dateValue:C}),d.rv({environment:t,collectionContextStore:S,block_id:r.id,property:l,property_type:"date",from:"calendar"})}}function k(e){const{calendarStore:t,direction:o,targetStore:r}=e;t.setState({...t.state,isDragging:!0,targetStore:r,direction:o,temporaryValue:void 0})}function h(e){const{calendarStore:t,x:o,y:l,calendarBy:p}=e,d=t.state;if(d.isDragging){const e=n.Gl(d.targetStore.getPropertyStore(p).getValue());if(!e)return;const u=a.c$(e,(0,c.r)()),m=d.temporaryValue||e,f=a.c$(m,(0,c.r)()),S=[];d.dayStoreMap.forEach(((e,t)=>{S.push({store:e,timestamp:t})}));const v=S.find((e=>{let{store:t}=e;const r=g.C.getRectFromStore(t);return Boolean(r&&y.uh(r,o,l))}));let _;if(v){const e=r.ou.fromMillis(v.timestamp),t=e.endOf("day"),o=e.toFormat(a.Iq);if(u){const n=a.NK(u,(0,c.r)());if(d.direction===w.t.Left)if(r.Xp.fromDateTimes(e,t).contains(n.start))_=u;else{let e;e="datetimerange"===u.type||"daterange"===u.type?{...u,start_date:o,end_date:u.end_date}:"datetime"===u.type?{type:"datetimerange",start_date:o,start_time:u.start_time,end_date:u.start_date,end_time:u.start_time,time_zone:u.time_zone,reminder:u.reminder}:{type:"daterange",start_date:o,end_date:u.start_date,reminder:u.reminder};const t=a.NK(e,(0,c.r)());_=!n.end&&t.start>n.start||n.end&&t.start>n.end?f:e}else if(n.end?r.Xp.fromDateTimes(e,t).contains(n.end):r.Xp.fromDateTimes(e,t).contains(n.start))_=u;else{let e;e="date"===u.type?{...u,type:"daterange",end_date:o}:"datetime"===u.type?{...u,type:"datetimerange",end_date:o,end_time:"00:00"}:{...u,end_date:o};const t=a.NK(e,(0,c.r)());_=t.end&&t.end<t.start?f:e}}}if(_&&!s.Xy(f,_)){const e=a.c$(_,i.yw(m)||(0,c.r)());t.setState({...d,temporaryValue:e})}}}function V(e){const{environment:t,calendarStore:o,calendarBy:r,transaction:n}=e,i=o.state;i.isDragging&&i.temporaryValue&&(I({type:"dateValue",environment:t,dateValue:i.temporaryValue,propertyId:r,store:i.targetStore,transaction:n}),o.setState({...o.state,isDragging:!1}))}function B(e){const{calendarStore:t}=e,o=t.state;o.isDragging&&t.setState({...o,isDragging:!1})}function P(e){const{environment:t,store:o,collectionStore:i,collectionContextStore:l,startDayOfWeek:s,transaction:p}=e,d=l.dateRangeStartStore.state,m=(0,c.r)(),f=l.normalizedQueryStore.state;if(!f||!f.calendar_by)return;const v=(null==i?void 0:i.getMappedProperty(f.calendar_by))??f.calendar_by,_=a.gQ(d,s,m),g=_.startOf("month"),y=_.endOf("month"),b=r.ou.now().startOf("day");let w;return w=r.Xp.fromDateTimes(g,y).contains(b)?a.hT(b.valueOf(),m):a.hT(a.em(d,s,m).valueOf(),m),S.sW({store:o.getPropertiesStore(),data:{[v]:n.d7(w)},transaction:p}),u.mp({environment:t,store:o,collectionStore:i,collectionContextStore:l,shouldCoerce:!0,groupsPointer:[],transaction:p}),o}function I(e){const{environment:t,store:o,propertyId:r,transaction:i}=e;let l;"timestamp"===e.type?l=a.hT(e.timestampMs.valueOf(),(0,c.r)()):"dateValue"===e.type?l=e.dateValue:(0,p.t1)(e);const s=o.getPropertyValue(r),d=n.d7(l);S.sW({store:o.getPropertiesStore(),data:{[r]:d},transaction:i}),m.H({environment:t,store:o,dateProperty:{id:r,oldValue:s,newValue:d}})}function T(e){const{environment:t,collectionStore:o,calendarBy:r,store:n,insertStores:i,collectionContextStore:a,transaction:c}=e,l=n.getPropertyStore(r).getValue();for(const s of i)u.mp({environment:t,store:s,collectionStore:o,collectionContextStore:a,shouldCoerce:!0,groupsPointer:[],transaction:c}),v.sO({environment:t,store:s.getNormalizedPropertyStore(r),value:l,transaction:c});return i.map((e=>b.G.createChildStore(o,e.pointer)))}}}]);